"""
修复像素分辨率混用问题的方案

问题描述：
- 去年掩码来自基准数据（0.218米/像素）
- 今年图像分辨率是0.097米/像素
- 系统将去年掩码resize到今年图像尺寸，但仍用今年分辨率计算面积
- 这导致面积计算错误（68.710亩 vs 正确的13.657亩）

解决方案：
1. 对于从基准数据来的掩码，始终使用基准分辨率计算面积
2. 对于新识别的像素，使用今年分辨率计算面积
3. 添加检查防止异常大的面积
"""

def 计算混合面积(耕地掩码, 基准掩码, 基准分辨率, 今年分辨率):
    """
    分别计算基准区域和新识别区域的面积

    Args:
        耕地掩码: 最终的耕地掩码
        基准掩码: 原始的基准掩码（已resize）
        基准分辨率: 0.218米/像素
        今年分辨率: 0.097米/像素

    Returns:
        正确的耕地面积（亩）
    """
    # 确保掩码是二值的
    耕地二值 = (耕地掩码 > 0.5)
    基准二值 = (基准掩码 > 0.5)

    # 找出不同的区域
    # 1. 原有耕地（基准掩码为1的区域）
    原有耕地像素 = np.sum(基准二值)

    # 2. 新增耕地（耕地掩码为1但基准掩码为0的区域）
    新增耕地像素 = np.sum(耕地二值 & ~基准二值)

    # 计算面积
    # 原有耕地使用基准分辨率
    原有耕地_平方米 = 原有耕地像素 * (基准分辨率 ** 2)

    # 新增耕地使用今年分辨率
    新增耕地_平方米 = 新增耕地像素 * (今年分辨率 ** 2)

    # 总面积
    总面积_平方米 = 原有耕地_平方米 + 新增耕地_平方米
    总面积_亩 = 总面积_平方米 / 666.67

    return 总面积_亩, 原有耕地像素, 新增耕地像素

print("""
使用说明：
1. 在耕地分析工具_图形界面.py中，获取今年结果后
2. 检查面积是否异常大（>50亩）
3. 如果异常，使用混合计算方法重新计算
4. 这样可以确保原有耕地使用正确的分辨率
""")