"""
æ”¹è¿›çš„é¢œè‰²è¯†åˆ«æ¨¡å—
é’ˆå¯¹è¯†åˆ«é¢ç§¯åå¤§çš„é—®é¢˜è¿›è¡Œä¼˜åŒ–
"""
import numpy as np
from sklearn.cluster import KMeans

def æ”¹è¿›çš„é¢œè‰²è¯†åˆ«(å›¾åƒå—, å»å¹´å—æ©ç =None, ä¸¥æ ¼ç¨‹åº¦=1.0):
    """
    æ”¹è¿›çš„é¢œè‰²è¯†åˆ«å‡½æ•°ï¼Œä½¿ç”¨æ›´ä¸¥æ ¼çš„é˜ˆå€¼

    Args:
        å›¾åƒå—: è¾“å…¥çš„RGBå›¾åƒå—
        å»å¹´å—æ©ç : å»å¹´çš„è€•åœ°æ©ç ï¼ˆå¯é€‰ï¼‰
        ä¸¥æ ¼ç¨‹åº¦: 1.0ä¸ºé»˜è®¤ï¼Œ>1.0æ›´ä¸¥æ ¼ï¼Œ<1.0æ›´å®½æ¾

    Returns:
        è€•åœ°æ©ç æ•°ç»„
    """
    # ç¡®ä¿è¾“å…¥æ˜¯uint8æ ¼å¼
    if å›¾åƒå—.max() <= 1.0:
        å— = (å›¾åƒå— * 255).astype(np.uint8)
    else:
        å— = å›¾åƒå—.astype(np.uint8)

    # è½¬æ¢åˆ°HSV
    try:
        import cv2
        HSV = cv2.cvtColor(å—, cv2.COLOR_RGB2HSV)
        H, S, V = HSV[:,:,0], HSV[:,:,1], HSV[:,:,2]
    except:
        # å¦‚æœOpenCVä¸å¯ç”¨ï¼Œè·³è¿‡HSVå¤„ç†
        H = S = V = np.zeros_like(å—[:,:,0])

    # åœ¨RGBç©ºé—´è®¡ç®—
    R, G, B = å—[:,:,0].astype(np.float32), å—[:,:,1].astype(np.float32), å—[:,:,2].astype(np.float32)

    # åŠ¨æ€è°ƒæ•´é˜ˆå€¼
    ç»¿è‰²é˜ˆå€¼ = int(30 * ä¸¥æ ¼ç¨‹åº¦)  # é»˜è®¤30ï¼Œä¸¥æ ¼æ—¶æ›´é«˜
    æ£•è‰²é˜ˆå€¼ = int(25 * ä¸¥æ ¼ç¨‹åº¦)  # é»˜è®¤25ï¼Œä¸¥æ ¼æ—¶æ›´é«˜
    æœ€å°äº®åº¦ = int(50 * ä¸¥æ ¼ç¨‹åº¦)  # é»˜è®¤50ï¼Œä¸¥æ ¼æ—¶æ›´é«˜
    æœ€å¤§äº®åº¦ = int(200 / ä¸¥æ ¼ç¨‹åº¦) if ä¸¥æ ¼ç¨‹åº¦ > 1 else 200  # ä¸¥æ ¼æ—¶æ›´ä½

    # 1. æ›´ä¸¥æ ¼çš„ç»¿è‰²æ£€æµ‹
    green_diff_rg = G - R
    green_diff_bg = G - B
    # å¢åŠ äº†Gé€šé“çš„æœ€å°å€¼è¦æ±‚ï¼Œå¹¶æé«˜äº†å·®å¼‚é˜ˆå€¼
    mask_green = (green_diff_rg > ç»¿è‰²é˜ˆå€¼) & (green_diff_bg > ç»¿è‰²é˜ˆå€¼) & (G > 80) & (S > 30)

    # 2. æ›´ä¸¥æ ¼çš„æ£•è‰²æ£€æµ‹
    brown_diff_rb = R - B
    brown_diff_rg = np.maximum(0, R - G)
    # å¢åŠ äº†æ¡ä»¶ï¼Œè¦æ±‚æ£•è‰²æ›´æ˜æ˜¾
    mask_brown = (brown_diff_rb > æ£•è‰²é˜ˆå€¼) & (brown_diff_rg > 10) & (R > 80) & (B < R * 0.7)

    # 3. æ›´ä¸¥æ ¼çš„é»„è‰²æ£€æµ‹
    # è¦æ±‚Rå’ŒGéƒ½æ›´é«˜ï¼Œä¸”Bæ›´ä½
    mask_yellow = (R > 120) & (G > 120) & (B < 100) & (np.abs(R - G) < 25)

    # 4. æ’é™¤éè€•åœ°ï¼ˆæ›´ä¸¥æ ¼çš„æ¡ä»¶ï¼‰
    äº®åº¦ = (R + G + B) / 3

    # æ’é™¤è¿‡æš—ï¼ˆé˜´å½±ã€æ°´ä½“ï¼‰
    mask_too_dark = äº®åº¦ < æœ€å°äº®åº¦

    # æ’é™¤è¿‡äº®ï¼ˆå»ºç­‘ç‰©ã€ç™½äº‘ï¼‰
    mask_too_bright = äº®åº¦ > æœ€å¤§äº®åº¦

    # æ›´ä¸¥æ ¼çš„æ°´ä½“æ£€æµ‹
    blue_dominant = (B > R * 1.3) & (B > G * 1.3) & (B > 80)

    # æ’é™¤ç°è‰²ï¼ˆé“è·¯ã€å²©çŸ³ã€å»ºç­‘ç‰©ï¼‰
    rg_diff = np.abs(R - G)
    gb_diff = np.abs(G - B)
    rb_diff = np.abs(R - B)
    # é™ä½äº†ç°è‰²å®¹å¿åº¦
    gray_like = (rg_diff < 10) & (gb_diff < 10) & (rb_diff < 10)

    # 5. é¢å¤–è¿‡æ»¤æ¡ä»¶
    # æ’é™¤é¥±å’Œåº¦è¿‡ä½çš„åŒºåŸŸï¼ˆå¯èƒ½æ˜¯ç™½è‰²å»ºç­‘ç‰©ï¼‰
    mask_low_saturation = S < 20

    # åˆå¹¶æ‰€æœ‰è€•åœ°æ©ç 
    mask_farmland = (mask_green | mask_brown | mask_yellow) & \
                   ~mask_too_dark & ~mask_too_bright & \
                   ~blue_dominant & ~gray_like & \
                   ~mask_low_saturation

    # 6. å½¢æ€å­¦åå¤„ç†ï¼ˆå»é™¤å°å™ªç‚¹ï¼‰
    try:
        import cv2
        kernel = np.ones((3,3), np.uint8)
        # å…ˆè…èš€å»é™¤è¾¹ç¼˜å™ªç‚¹
        mask_farmland = cv2.erode(mask_farmland.astype(np.uint8), kernel, iterations=1)
        # å†è†¨èƒ€æ¢å¤ä¸»è¦åŒºåŸŸ
        mask_farmland = cv2.dilate(mask_farmland, kernel, iterations=1)
        # å¼€è¿ç®—å»é™¤å­¤ç«‹å°ç‚¹
        mask_farmland = cv2.morphologyEx(mask_farmland, cv2.MORPH_OPEN, kernel)
    except:
        pass

    return mask_farmland.astype(float)

def è®¡ç®—æœ€ä¼˜ä¸¥æ ¼ç¨‹åº¦(tif_path, åƒç´ åˆ†è¾¨ç‡, é¢„æœŸé¢ç§¯_äº©=12.6):
    """
    é€šè¿‡æµ‹è¯•ä¸åŒçš„ä¸¥æ ¼ç¨‹åº¦æ¥æ‰¾åˆ°æœ€ä¼˜å‚æ•°

    Returns:
        æœ€ä¼˜çš„ä¸¥æ ¼ç¨‹åº¦å‚æ•°
    """
    import rasterio

    with rasterio.open(tif_path) as src:
        å›¾åƒæ•°æ® = src.read()
        if å›¾åƒæ•°æ®.shape[0] <= 4:
            å›¾åƒ = np.transpose(å›¾åƒæ•°æ®[:3], (1, 2, 0))
        else:
            å›¾åƒ = å›¾åƒæ•°æ®[1:4]

    if å›¾åƒ.max() > 1.0:
        å›¾åƒ = å›¾åƒ.astype(np.float32) / 255.0

    # ä½¿ç”¨ä¸­å¿ƒåŒºåŸŸæµ‹è¯•
    h, w = å›¾åƒ.shape[:2]
    æµ‹è¯•å— = å›¾åƒ[h//4:3*h//4, w//4:3*w//4]

    é¢„æœŸåƒç´ æ•° = (é¢„æœŸé¢ç§¯_äº© * 666.67) / (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡)
    æµ‹è¯•å—é¢„æœŸåƒç´  = é¢„æœŸåƒç´ æ•° * (æµ‹è¯•å—.shape[0] * æµ‹è¯•å—.shape[1]) / (å›¾åƒ.shape[0] * å›¾åƒ.shape[1])

    best_strictness = 1.0
    min_diff = float('inf')

    print(f"\nğŸ” å¯»æ‰¾æœ€ä¼˜ä¸¥æ ¼ç¨‹åº¦...")
    print(f"   æµ‹è¯•å—é¢„æœŸåƒç´ æ•°: {æµ‹è¯•å—é¢„æœŸåƒç´ :.0f}")

    # æµ‹è¯•ä¸åŒçš„ä¸¥æ ¼ç¨‹åº¦
    for strictness in np.linspace(0.7, 1.5, 17):  # ä»0.7åˆ°1.5ï¼Œæ­¥é•¿0.05
        æ©ç  = æ”¹è¿›çš„é¢œè‰²è¯†åˆ«(æµ‹è¯•å—, ä¸¥æ ¼ç¨‹åº¦=strictness)
        åƒç´ æ•° = np.sum(æ©ç  > 0.5)
        å·®å¼‚ = abs(åƒç´ æ•° - æµ‹è¯•å—é¢„æœŸåƒç´ )

        if å·®å¼‚ < min_diff:
            min_diff = å·®å¼‚
            best_strictness = strictness

    print(f"\nâœ… æœ€ä¼˜ä¸¥æ ¼ç¨‹åº¦: {best_strictness:.2f}")
    print(f"   æœ€å°å·®å¼‚: {min_diff:.0f} åƒç´ ")

    # ä½¿ç”¨æœ€ä¼˜å‚æ•°é‡æ–°è¯†åˆ«
    æœ€ä¼˜æ©ç  = æ”¹è¿›çš„é¢œè‰²è¯†åˆ«(æµ‹è¯•å—, ä¸¥æ ¼ç¨‹åº¦=best_strictness)
    æœ€ä¼˜åƒç´ æ•° = np.sum(æœ€ä¼˜æ©ç  > 0.5)
    æœ€ä¼˜é¢ç§¯ = æœ€ä¼˜åƒç´ æ•° * (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡) / 666.67

    print(f"\nğŸ“Š ä½¿ç”¨æœ€ä¼˜å‚æ•°çš„ç»“æœ:")
    print(f"   è¯†åˆ«åƒç´ æ•°: {æœ€ä¼˜åƒç´ æ•°:,.0f}")
    print(f"   è¯†åˆ«é¢ç§¯: {æœ€ä¼˜é¢ç§¯:.2f} äº©")
    print(f"   ä¸é¢„æœŸçš„å·®å¼‚: {abs(æœ€ä¼˜é¢ç§¯ - é¢„æœŸé¢ç§¯_äº©):.2f} äº©")

    return best_strictness

if __name__ == "__main__":
    # æµ‹è¯•ä»Šå¹´å›¾åƒ
    import os
    if os.path.exists("jinnian.tif"):
        print("æµ‹è¯•ä»Šå¹´å›¾åƒ: jinnian.tif")
        æœ€ä¼˜å‚æ•° = è®¡ç®—æœ€ä¼˜ä¸¥æ ¼ç¨‹åº¦("jinnian.tif", 0.054500, 12.6)
        print(f"\nğŸ’¡ å»ºè®®ä½¿ç”¨çš„ä¸¥æ ¼ç¨‹åº¦å‚æ•°: {æœ€ä¼˜å‚æ•°:.2f}")