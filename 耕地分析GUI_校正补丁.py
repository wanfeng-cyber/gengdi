"""
耕地分析工具GUI校正功能补丁
在原有代码基础上添加可配置的校正功能
"""

# ========================================
# 第1步：在文件开头的import部分后添加（约第30行后）
# ========================================

import json  # 添加json导入

# 添加校正管理器类
class 校正管理器:
    """简化的校正管理器"""

    def __init__(self):
        self.配置文件 = "校正配置.json"
        self.参考面积 = 12.6
        self.启用校正 = True
        self.加载配置()

    def 加载配置(self):
        """加载配置"""
        if os.path.exists(self.配置文件):
            try:
                with open(self.配置文件, 'r', encoding='utf-8') as f:
                    config = json.load(f)
                    self.参考面积 = config.get("参考面积", 12.6)
                    self.启用校正 = config.get("启用校正", True)
            except:
                pass

    def 保存配置(self):
        """保存配置"""
        try:
            config = {
                "参考面积": self.参考面积,
                "启用校正": self.启用校正
            }
            with open(self.配置文件, 'w', encoding='utf-8') as f:
                json.dump(config, f, ensure_ascii=False, indent=2)
        except:
            pass

    def 应用校正(self, 计算面积, 参考面积=None):
        """应用校正"""
        if not self.启用校正 or 计算面积 <= 0:
            return 计算面积, 1.0, False

        if 参考面积 is None:
            参考面积 = self.参考面积

        if 参考面积 <= 0:
            return 计算面积, 1.0, False

        校正系数 = 参考面积 / 计算面积
        偏差 = abs(校正系数 - 1.0)

        if 偏差 > 0.01:
            校正后面积 = 计算面积 * 校正系数
            return 校正后面积, 校正系数, True

        return 计算面积, 1.0, False


# ========================================
# 第2步：在__init__方法中初始化校正管理器（约第180行后）
# ========================================

# 在class 耕地分析GUI的__init__方法中添加：
self.校正管理器 = 校正管理器()


# ========================================
# 第3步：在创建左侧面板时添加校正配置界面（约第200行后）
# ========================================

# 在创建系统信息框之前添加：
# 校正配置区域
校正配置框 = tk.LabelFrame(左侧面板,
                           text="🔧 面积校正配置",
                           font=("微软雅黑", 10, "bold"),
                           bg=self.bg_dark, fg=self.text_primary)
校正配置框.pack(padx=20, pady=5, fill="x")

# 参考面积输入
参考面积框 = tk.Frame(校正配置框, bg=self.bg_dark)
参考面积框.pack(pady=5, padx=10, fill="x")

tk.Label(参考面积框, text="参考面积(亩):",
        font=("微软雅黑", 9),
        bg=self.bg_dark, fg=self.text_secondary).pack(side="left")

self.参考面积输入 = tk.Entry(参考面积框,
                            font=("微软雅黑", 9),
                            width=8)
self.参考面积输入.pack(side="left", padx=(5, 0))
self.参考面积输入.insert(0, str(self.校正管理器.参考面积))

# 启用校正复选框
self.启用校正变量 = tk.BooleanVar(value=self.校正管理器.启用校正)
启用校正框 = tk.Checkbutton(校正配置框,
                           text="启用自动校正",
                           variable=self.启用校正变量,
                           font=("微软雅黑", 9),
                           bg=self.bg_dark, fg=self.text_secondary,
                           selectcolor=self.bg_dark,
                           command=self.更新校正配置)
启用校正框.pack(anchor="w", padx=10, pady=(0, 5))


# ========================================
# 第4步：添加更新校正配置的方法（在class 耕地分析GUI中添加新方法）
# ========================================

def 更新校正配置(self):
    """更新校正配置"""
    try:
        # 获取参考面积
        参考面积 = float(self.参考面积输入.get())

        # 更新管理器
        self.校正管理器.参考面积 = 参考面积
        self.校正管理器.启用校正 = self.启用校正变量.get()

        # 保存配置
        self.校正管理器.保存配置()

        self.输出结果(f"✅ 校正配置已更新：参考面积 {参考面积} 亩")

    except ValueError:
        self.输出结果("❌ 请输入有效的数字")
        # 恢复原值
        self.参考面积_input.delete(0, "end")
        self.参考面积_input.insert(0, str(self.校正管理器.参考面积))


# ========================================
# 第5步：替换原有的硬编码校正部分（约第1086-1096行）
# ========================================

"""
删除或注释掉以下原有代码：
# 校正系数（基于测试区域的实际测量值）
# 目标：12.6亩，当前：13.679亩
测试区域校正系数 = 12.6 / 13.679  # ≈ 0.921

# 只对去年数据应用校正
if abs(测试区域校正系数 - 1.0) > 0.01:
    去年耕地面积_亩 = 去年耕地面积_亩 * 测试区域校正系数
    self.输出结果(f"\n⚙️  应用测试区域校正系数: {测试区域校正系数:.3f}")
    self.输出结果(f"   原始面积: {精确去年面积:.3f} 亩")
    self.输出结果(f"   校正后面积: {去年耕地面积_亩:.3f} 亩")
    self.输出结果(f"   注: 基于测试区域真实值12.6亩")
"""

替换为：

# 应用动态校正
原始去年面积 = 去年耕地面积_亩
去年耕地面积_亩, 校正系数, 已校正 = self.校正管理器.应用校正(去年耕地面积_亩)

if 已校正:
    self.输出结果(f"\n⚙️  应用自动校正:")
    self.输出结果(f"   原始面积: {原始去年面积:.3f} 亩")
    self.输出结果(f"   校正系数: {校正系数:.3f}")
    self.输出结果(f"   校正后面积: {去年耕地面积_亩:.3f} 亩")
    self.输出结果(f"   参考面积: {self.校正管理器.参考面积} 亩")


# ========================================
# 第6步：同样更新今年数据的校正（如果需要）
# ========================================

# 在计算今年面积后（约第1150行后），可以添加类似的校正：
# 原始今年面积 = 当前耕地面积_亩
# 当前耕地面积_亩, _, _ = self.校正管理器.应用校正(当前耕地面积_亩)


# ========================================
# 使用说明
# ========================================

print("""
耕地分析工具校正功能集成指南
========================================

1. 将上述代码片段按说明插入到 耕地分析工具_图形界面.py 的相应位置

2. 主要修改：
   - 添加了校正管理器类
   - 在GUI中添加了校正配置界面
   - 将硬编码的校正改为动态配置

3. 新增功能：
   - 用户可以输入测试区域的参考面积
   - 可以启用/禁用校正功能
   - 配置会自动保存到 校正配置.json
   - 系统自动计算并应用校正系数

4. 使用方法：
   - 启动程序后，在左侧面板找到"面积校正配置"
   - 输入测试区域的实际面积（如12.6）
   - 勾选"启用自动校正"
   - 系统会自动应用校正

5. 优势：
   - 无需修改代码即可调整校正参数
   - 支持多个不同的测试区域
   - 配置持久化保存
   - 界面友好，操作简单
""")


# 创建一个快速集成脚本
def 创建集成脚本():
    """创建自动集成脚本"""
    脚本内容 = '''
@echo off
echo 耕地分析工具校正功能集成向导
echo ===============================
echo.
echo 此脚本将帮助您将校正功能集成到现有的GUI中
echo 请确保已备份 耕地分析工具_图形界面.py
echo.
pause

python -c "
import os
import shutil

# 备份原文件
if os.path.exists('耕地分析工具_图形界面.py'):
    shutil.copy2('耕地分析工具_图形界面.py', '耕地分析工具_图形界面_备份.py')
    print('✅ 已备份原文件')
else:
    print('❌ 找不到 耕地分析工具_图形界面.py')
    exit(1)

print('\\n请手动按照 耕地分析GUI_校正补丁.py 中的说明进行修改')
print('修改完成后，程序将支持可配置的校正功能')
"
'''

    with open("集成校正功能.bat", "w", encoding="utf-8") as f:
        f.write(脚本内容)

    print("✅ 已创建集成脚本: 集成校正功能.bat")


if __name__ == "__main__":
    创建集成脚本()

    print("\n📝 集成步骤：")
    print("1. 打开 耕地分析工具_图形界面.py")
    print("2. 按照上述说明添加代码片段")
    print("3. 或运行 集成校正功能.bat 获取帮助")
    print("4. 测试新功能是否正常工作")

    print("\n⚠️ 注意：")
    print("- 修改前请备份原文件")
    print("- 确保json模块已导入")
    print("- 测试时输入不同的参考面积值")