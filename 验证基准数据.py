"""
验证基准数据是否准确
"""
import pickle
import numpy as np
import os

def 验证基准数据():
    print("="*60)
    print("基准数据验证工具")
    print("="*60)

    基准数据文件 = None
    if os.path.exists("基准数据.pkl"):
        基准数据文件 = "基准数据.pkl"
    elif os.path.exists("耕地识别模型_基准数据.pkl"):
        基准数据文件 = "耕地识别模型_基准数据.pkl"

    if not 基准数据文件:
        print("❌ 错误：找不到基准数据文件")
        return

    with open(基准数据文件, 'rb') as f:
        基准信息 = pickle.load(f)

    # 基本信息
    print("\n📊 基准数据信息:")
    print(f"   基准年份: {基准信息.get('基准年份', 'N/A')}")
    print(f"   像素分辨率: {基准信息.get('像素分辨率_米', 'N/A')} 米/像素")

    # 获取基准地图
    基准地图 = 基准信息['基准耕地地图']
    像素分辨率 = 基准信息.get('像素分辨率_米', 0.218)

    # 统计信息
    总像素 = 基准地图.size
    耕地像素 = np.sum(基准地图 > 0.5)
    耕地比例 = 耕地像素 / 总像素
    单像素面积 = 像素分辨率 * 像素分辨率
    耕地面积_平方米 = 耕地像素 * 单像素面积
    耕地面积_亩 = 耕地面积_平方米 / 666.67

    print(f"\n📐 基准地图统计:")
    print(f"   尺寸: {基准地图.shape}")
    print(f"   总像素数: {总像素:,}")
    print(f"   耕地像素数: {耕地像素:,}")
    print(f"   耕地比例: {耕地比例*100:.1f}%")
    print(f"   单像素面积: {单像素面积:.6f} 平方米")
    print(f"   耕地面积: {耕地面积_亩:.2f} 亩")

    # 如果有shapefile信息，检查一下
    if '基准shp文件' in 基准信息:
        print(f"\n📁 基准Shapefile: {基准信息['基准shp文件']}")

    # 分析问题
    预期面积 = 12.6
    偏差 = 耕地面积_亩 - 预期面积
    偏差百分比 = 偏差 / 预期面积 * 100

    print(f"\n🔍 问题分析:")
    print(f"   预期面积: {预期面积} 亩")
    print(f"   基准数据面积: {耕地面积_亩:.2f} 亩")
    print(f"   偏差: {偏差:+.2f} 亩 ({偏差百分比:+.1f}%)")

    if abs(偏差) > 1.0:
        print(f"\n⚠️ 警告：基准数据与预期值差异较大！")
        print(f"\n可能的原因：")
        print(f"1. 基准数据创建时识别阈值过于宽松")
        print(f"2. 包含了非耕地（道路、沟渠、建筑物等）")
        print(f"3. 实际耕地面积发生变化")

    # 建议的校正因子
    if 耕地面积_亩 > 0:
        校正因子 = 预期面积 / 耕地面积_亩
        print(f"\n💡 建议的校正因子: {校正因子:.4f}")
        print(f"   如果将基准数据乘以这个因子，可以得到接近{预期面积}亩的结果")

    # 测试不同阈值
    print(f"\n🔧 测试不同阈值的效果:")
    阈值列表 = [0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9]

    for 阈值 in 阈值列表:
        测试耕地像素 = np.sum(基准地图 > 阈值)
        测试面积 = 测试耕地像素 * 单像素面积 / 666.67
        差异 = abs(测试面积 - 预期面积)

        print(f"   阈值 {阈值}: {测试耕地像素:,} 像素, {测试面积:.2f} 亩 (差异: {差异:.2f})")

    print("\n" + "="*60)

if __name__ == "__main__":
    验证基准数据()