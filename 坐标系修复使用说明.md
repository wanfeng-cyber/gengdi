# 坐标系修复使用说明

## 问题描述

你的系统出现了坐标系不匹配的问题：
- **基准数据（去年）**：使用 CGCS2000 CM 126E（中央经线126°）
- **今年图像**：使用 CGCS2000 CM 129E（中央经线129°）

这导致了严重的面积计算错误（2.719亩 vs 12.668亩，差异365%）。

## 已实施的修复

### 1. 创建的新文件
- `坐标系处理模块.py` - 提供坐标系检查和转换功能
- `修复坐标系差异.py` - 专门用于处理去年的掩码数据
- `坐标系统修复.py` - 独立工具，可以手动修复坐标系
- `自动坐标系修复示例.py` - 展示如何自动处理坐标系

### 2. 修改的文件
- `耕地分析系统.py` - 添加了坐标系处理模块导入
- `耕地分析工具_图形界面.py` - 集成了自动坐标系转换

## 工作原理

1. **检测坐标系差异**：系统会自动检测基准数据和今年图像的坐标系
2. **创建临时TIF文件**：将去年的裁剪区域保存为带坐标系的TIF文件
3. **坐标转换**：使用rasterio将去年数据转换到今年图像的坐标系
4. **替换数据**：使用转换后的数据进行比较分析

## 使用方法

### 方法1：通过图形界面（推荐）
直接运行图形界面，系统会自动处理坐标系差异：
```bash
python 耕地分析工具_图形界面.py
```

### 方法2：使用独立工具
如果需要手动修复：
```bash
python 坐标系统修复.py
```

### 方法3：批量处理
如果有大量文件需要处理：
```python
from 自动坐标系修复示例 import 智能耕地分析器

分析器 = 智能耕地分析器()
结果 = 分析器.智能比较两年数据(去年图像, 今年图像, 模型路径)
```

## 预期结果

修复后，你应该看到：
- 面积差异在合理范围内（通常<10%）
- 不再有"严重警告：面积变化异常"的提示
- 去年和今年的耕地面积基本一致（如果没有实际变化）

## 注意事项

1. **转换需要时间**：坐标转换可能需要几秒到几分钟，取决于图像大小
2. **临时文件**：系统会创建临时文件，处理完后自动清理
3. **内存使用**：大图像的坐标转换会占用更多内存
4. **精度保证**：转换使用最近邻重采样，保持二值掩码的准确性

## 故障排除

如果遇到问题：

1. **模块导入错误**：确保所有新文件都在同一目录下
2. **转换失败**：检查原始图像是否有正确的坐标系信息
3. **仍然差异大**：可能是图像覆盖范围不同，检查WGS84坐标是否重叠

## 技术细节

坐标系转换使用以下步骤：
1. 将今年图像的WGS84坐标转换到基准数据的坐标系
2. 在基准数据中裁剪对应区域
3. 创建带坐标系的临时TIF文件
4. 使用rasterio.warp.reproject转换到今年图像的坐标系
5. 返回转换后的掩码数组

这确保了去年和今年的数据在完全相同的坐标系下进行比较。