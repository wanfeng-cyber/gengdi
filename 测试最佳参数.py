"""
æµ‹è¯•ä¸åŒçš„é¢œè‰²è¯†åˆ«å‚æ•°ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘12.6äº©çš„è®¾ç½®
"""
import numpy as np
import rasterio
import os

def æµ‹è¯•ç»¿è‰²é˜ˆå€¼():
    """æµ‹è¯•ä¸åŒçš„ç»¿è‰²é˜ˆå€¼å¯¹è¯†åˆ«ç»“æœçš„å½±å“"""
    print("="*60)
    print("æµ‹è¯•é¢œè‰²è¯†åˆ«å‚æ•°")
    print("="*60)

    # æ‰“å¼€å›¾åƒ
    with rasterio.open("jinnian.tif") as src:
        # è¯»å–ä¸­å¿ƒåŒºåŸŸè¿›è¡Œæµ‹è¯•
        window = rasterio.windows.Window(
            src.width//4, src.height//4,
            src.width//2, src.height//2
        )
        data = src.read(window=window)

        if data.shape[0] <= 4:
            å›¾åƒ = np.transpose(data[:3], (1, 2, 0))
        else:
            å›¾åƒ = data[1:4]

    # å½’ä¸€åŒ–
    if å›¾åƒ.max() > 1.0:
        å›¾åƒ = å›¾åƒ.astype(np.float32) / 255.0

    # è½¬æ¢ä¸º0-255èŒƒå›´
    å— = (å›¾åƒ * 255).astype(np.uint8)
    R, G, B = å—[:,:,0].astype(np.float32), å—[:,:,1].astype(np.float32), å—[:,:,2].astype(np.float32)

    # ç›®æ ‡å€¼
    é¢„æœŸé¢ç§¯_äº© = 12.6
    åƒç´ åˆ†è¾¨ç‡ = 0.0972  # ä»jinnian.tifè·å–
    æµ‹è¯•å—åƒç´  = å—.shape[0] * å—.shape[1]
    å…¨å›¾åƒç´  = src.width * src.height
    ç¼©æ”¾å› å­ = å…¨å›¾åƒç´  / æµ‹è¯•å—åƒç´ 

    # è®¡ç®—æµ‹è¯•å—éœ€è¦çš„åƒç´ æ•°
    é¢„æœŸå¹³æ–¹ç±³ = é¢„æœŸé¢ç§¯_äº© * 666.67
    é¢„æœŸå…¨å›¾åƒç´  = é¢„æœŸå¹³æ–¹ç±³ / (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡)
    é¢„æœŸæµ‹è¯•å—åƒç´  = é¢„æœŸå…¨å›¾åƒç´  / ç¼©æ”¾å› å­

    print(f"\nğŸ“Š æµ‹è¯•ä¿¡æ¯:")
    print(f"   å›¾åƒåˆ†è¾¨ç‡: {åƒç´ åˆ†è¾¨ç‡:.6f} ç±³/åƒç´ ")
    print(f"   æµ‹è¯•å—å°ºå¯¸: {å—.shape[:2]}")
    print(f"   æµ‹è¯•å—åƒç´ æ•°: {æµ‹è¯•å—åƒç´ :,}")
    print(f"   ç¼©æ”¾åˆ°å…¨å›¾çš„å› å­: {ç¼©æ”¾å› å­:.2f}")
    print(f"   é¢„æœŸå…¨å›¾åƒç´ æ•°: {é¢„æœŸå…¨å›¾åƒç´ :,.0f}")
    print(f"   é¢„æœŸæµ‹è¯•å—åƒç´ æ•°: {é¢„æœŸæµ‹è¯•å—åƒç´ :,.0f}")

    print(f"\nğŸ” æµ‹è¯•ä¸åŒå‚æ•°ç»„åˆ:")

    # æµ‹è¯•å‚æ•°
    å‚æ•°åˆ—è¡¨ = [
        {"ç»¿è‰²é˜ˆå€¼": 30, "æ£•è‰²é˜ˆå€¼": 25, "ç»¿è‰²Gmin": 80, "æ£•è‰²Rmin": 90, "å": "åŸå‚æ•°"},
        {"ç»¿è‰²é˜ˆå€¼": 35, "æ£•è‰²é˜ˆå€¼": 30, "ç»¿è‰²Gmin": 90, "æ£•è‰²Rmin": 100, "å": "å·²æ”¹è¿›"},
        {"ç»¿è‰²é˜ˆå€¼": 40, "æ£•è‰²é˜ˆå€¼": 35, "ç»¿è‰²Gmin": 100, "æ£•è‰²Rmin": 110, "å": "æ›´ä¸¥æ ¼1"},
        {"ç»¿è‰²é˜ˆå€¼": 45, "æ£•è‰²é˜ˆå€¼": 40, "ç»¿è‰²Gmin": 110, "æ£•è‰²Rmin": 120, "å": "æ›´ä¸¥æ ¼2"},
        {"ç»¿è‰²é˜ˆå€¼": 50, "æ£•è‰²é˜ˆå€¼": 45, "ç»¿è‰²Gmin": 120, "æ£•è‰²Rmin": 130, "å": "æœ€ä¸¥æ ¼"},
    ]

    best_diff = float('inf')
    best_params = None

    for params in å‚æ•°åˆ—è¡¨:
        # åº”ç”¨å‚æ•°
        ç»¿è‰²é˜ˆå€¼ = params["ç»¿è‰²é˜ˆå€¼"]
        æ£•è‰²é˜ˆå€¼ = params["æ£•è‰²é˜ˆå€¼"]
        ç»¿è‰²Gmin = params["ç»¿è‰²Gmin"]
        æ£•è‰²Rmin = params["æ£•è‰²Rmin"]

        # ç»¿è‰²æ£€æµ‹
        green_diff_rg = G - R
        green_diff_bg = G - B
        mask_green = (green_diff_rg > ç»¿è‰²é˜ˆå€¼) & (green_diff_bg > ç»¿è‰²é˜ˆå€¼) & (G > ç»¿è‰²Gmin)

        # æ£•è‰²æ£€æµ‹
        brown_diff_rb = R - B
        brown_diff_rg = np.maximum(0, R - G)
        mask_brown = (brown_diff_rb > æ£•è‰²é˜ˆå€¼) & (brown_diff_rg > 10) & (R > æ£•è‰²Rmin) & (B < R * 0.7)

        # é»„è‰²æ£€æµ‹
        mask_yellow = (R > 140) & (G > 140) & (B < 120) & (np.abs(R - G) < 20)

        # æ’é™¤æ¡ä»¶
        äº®åº¦ = (R + G + B) / 3
        mask_too_dark = äº®åº¦ < 60
        mask_too_bright = äº®åº¦ > 190
        blue_dominant = (B > R * 1.3) & (B > G * 1.3) & (B > 80)

        # åˆå¹¶
        mask_farmland = (mask_green | mask_brown | mask_yellow) & \
                       ~mask_too_dark & ~mask_too_bright & \
                       ~blue_dominant

        # è®¡ç®—ç»“æœ
        è¯†åˆ«åƒç´  = np.sum(mask_farmland)
        è¯†åˆ«åƒç´ _å…¨å›¾ = è¯†åˆ«åƒç´  * ç¼©æ”¾å› å­
        è¯†åˆ«é¢ç§¯ = è¯†åˆ«åƒç´ _å…¨å›¾ * (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡) / 666.67

        ä¸é¢„æœŸå·®å¼‚ = abs(è¯†åˆ«é¢ç§¯ - é¢„æœŸé¢ç§¯_äº©)

        print(f"\n   {params['å']}:")
        print(f"     ç»¿è‰²é˜ˆå€¼={ç»¿è‰²é˜ˆå€¼}, æ£•è‰²é˜ˆå€¼={æ£•è‰²é˜ˆå€¼}")
        print(f"     æµ‹è¯•å—è¯†åˆ«åƒç´ : {è¯†åˆ«åƒç´ :,}")
        print(f"     å…¨å›¾è¯†åˆ«åƒç´ : {è¯†åˆ«åƒç´ _å…¨å›¾:,.0f}")
        print(f"     è¯†åˆ«é¢ç§¯: {è¯†åˆ«é¢ç§¯:.2f} äº©")
        print(f"     ä¸é¢„æœŸå·®å¼‚: {ä¸é¢„æœŸå·®å¼‚:.2f} äº©")

        if ä¸é¢„æœŸå·®å¼‚ < best_diff:
            best_diff = ä¸é¢„æœŸå·®å¼‚
            best_params = params.copy()
            best_params["åƒç´ æ•°"] = è¯†åˆ«åƒç´ _å…¨å›¾
            best_params["é¢ç§¯"] = è¯†åˆ«é¢ç§¯

    print(f"\nâœ… æœ€ä½³å‚æ•°ç»„åˆ:")
    print(f"   å‚æ•°å: {best_params['å']}")
    print(f"   ç»¿è‰²é˜ˆå€¼: {best_params['ç»¿è‰²é˜ˆå€¼']}")
    print(f"   æ£•è‰²é˜ˆå€¼: {best_params['æ£•è‰²é˜ˆå€¼']}")
    print(f"   ç»¿è‰²Gmin: {best_params['ç»¿è‰²Gmin']}")
    print(f"   æ£•è‰²Rmin: {best_params['æ£•è‰²Rmin']}")
    print(f"   è¯†åˆ«é¢ç§¯: {best_params['é¢ç§¯']:.2f} äº©")
    print(f"   ä¸é¢„æœŸå·®å¼‚: {best_diff:.2f} äº©")

    print("\n" + "="*60)

if __name__ == "__main__":
    æµ‹è¯•ç»¿è‰²é˜ˆå€¼()