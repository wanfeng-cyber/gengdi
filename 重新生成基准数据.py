"""
é‡æ–°ç”ŸæˆåŸºå‡†æ•°æ®PKLæ–‡ä»¶
åŠŸèƒ½ï¼šæ‰«ææ‰€æœ‰è®­ç»ƒTIFï¼Œç”Ÿæˆè¦†ç›–å…¨éƒ¨åŒºåŸŸçš„åŸºå‡†åœ°å›¾
"""

import os
import numpy as np
import rasterio
import geopandas as gpd
from rasterio.features import geometry_mask
from affine import Affine
from datetime import datetime
import pickle

# ==================== é…ç½®åŒºåŸŸ ====================

# TIFæ–‡ä»¶ç›®å½•ï¼ˆä¼šé€’å½’æ‰«ææ‰€æœ‰å­æ–‡ä»¶å¤¹ï¼‰
TIFç›®å½• = r"E:\å…«äºŒ\20250420é€šåŒ—å…«äºŒ2_3"

# SHPæ ‡æ³¨æ–‡ä»¶è·¯å¾„
SHPè·¯å¾„ = r"E:\é€šåŒ—å±€ç§æ¤ä½œç‰©\é€šåŒ—å±€ç§æ¤ä½œç‰©.shp"

# è¾“å‡ºPKLæ–‡ä»¶è·¯å¾„
è¾“å‡ºPKLè·¯å¾„ = r"d:\å¾®ä¿¡\document\xwechat_files\wxid_h80ke0c6ca1m22_27bc\msg\file\2025-11\001\001\python\è€•åœ°è¯†åˆ«æ¨¡å‹_åŸºå‡†æ•°æ®.pkl"

# é™é‡‡æ ·å› å­ï¼ˆæ•°å€¼è¶Šå¤§ï¼Œåœ°å›¾è¶Šå°ï¼‰
# 4x â†’ 0.32måˆ†è¾¨ç‡ â†’ çº¦193GBï¼ˆå¤ªå¤§ï¼‰
# 16x â†’ 1.28måˆ†è¾¨ç‡ â†’ çº¦12GBï¼ˆæ¨èï¼‰
# 32x â†’ 2.56måˆ†è¾¨ç‡ â†’ çº¦3GB
é™é‡‡æ ·å› å­ = 16  # âœ… ä¿®æ”¹ä¸º16xï¼Œå¹³è¡¡ç²¾åº¦å’Œå†…å­˜

# =================================================


def é€’å½’æ‰«æTIF(ç›®å½•):
    """é€’å½’æ‰«æç›®å½•ä¸‹æ‰€æœ‰TIFæ–‡ä»¶"""
    tifåˆ—è¡¨ = []
    
    if not os.path.exists(ç›®å½•):
        print(f"âŒ ç›®å½•ä¸å­˜åœ¨: {ç›®å½•}")
        return tifåˆ—è¡¨
    
    for æ ¹è·¯å¾„, å­æ–‡ä»¶å¤¹, æ–‡ä»¶åˆ—è¡¨ in os.walk(ç›®å½•):
        for æ–‡ä»¶å in æ–‡ä»¶åˆ—è¡¨:
            if æ–‡ä»¶å.lower().endswith('.tif'):
                tifåˆ—è¡¨.append(os.path.join(æ ¹è·¯å¾„, æ–‡ä»¶å))
    
    return tifåˆ—è¡¨


def è®¡ç®—è”åˆèŒƒå›´(tifåˆ—è¡¨):
    """è®¡ç®—æ‰€æœ‰TIFçš„è”åˆè¦†ç›–èŒƒå›´"""
    å…¨å±€_å·¦ = float('inf')
    å…¨å±€_å³ = float('-inf')
    å…¨å±€_ä¸Š = float('-inf')
    å…¨å±€_ä¸‹ = float('inf')
    åŸºå‡†_crs = None
    åŸºå‡†_åˆ†è¾¨ç‡ = None
    æœ‰æ•ˆTIF = []
    
    print(f"\nğŸ“Š è®¡ç®— {len(tifåˆ—è¡¨)} ä¸ªTIFçš„è”åˆèŒƒå›´...")
    print("=" * 60)
    
    for i, tifè·¯å¾„ in enumerate(tifåˆ—è¡¨, 1):
        try:
            with rasterio.open(tifè·¯å¾„) as src:
                if åŸºå‡†_crs is None:
                    åŸºå‡†_crs = src.crs
                    åŸºå‡†_åˆ†è¾¨ç‡ = abs(src.transform.a)
                
                # æ›´æ–°å…¨å±€èŒƒå›´
                å…¨å±€_å·¦ = min(å…¨å±€_å·¦, src.bounds.left)
                å…¨å±€_å³ = max(å…¨å±€_å³, src.bounds.right)
                å…¨å±€_ä¸Š = max(å…¨å±€_ä¸Š, src.bounds.top)
                å…¨å±€_ä¸‹ = min(å…¨å±€_ä¸‹, src.bounds.bottom)
                
                æœ‰æ•ˆTIF.append(tifè·¯å¾„)
                
                print(f"  [{i:2d}] âœ… {os.path.basename(tifè·¯å¾„)}")
                print(f"       X: {src.bounds.left:.2f} ~ {src.bounds.right:.2f}")
                print(f"       Y: {src.bounds.bottom:.2f} ~ {src.bounds.top:.2f}")
                
        except Exception as e:
            print(f"  [{i:2d}] âŒ {os.path.basename(tifè·¯å¾„)}: {e}")
    
    print("=" * 60)
    print(f"\nğŸŒ å…¨å±€è”åˆèŒƒå›´:")
    print(f"   X: {å…¨å±€_å·¦:.2f} ~ {å…¨å±€_å³:.2f} (å®½åº¦: {å…¨å±€_å³ - å…¨å±€_å·¦:.2f}m)")
    print(f"   Y: {å…¨å±€_ä¸‹:.2f} ~ {å…¨å±€_ä¸Š:.2f} (é«˜åº¦: {å…¨å±€_ä¸Š - å…¨å±€_ä¸‹:.2f}m)")
    print(f"   CRS: {åŸºå‡†_crs}")
    print(f"   åˆ†è¾¨ç‡: {åŸºå‡†_åˆ†è¾¨ç‡:.4f} m/åƒç´ ")
    
    # è½¬æ¢ä¸ºç»çº¬åº¦æ˜¾ç¤º
    if åŸºå‡†_crs:
        from pyproj import Transformer
        transformer = Transformer.from_crs(åŸºå‡†_crs, 'EPSG:4326', always_xy=True)
        lon1, lat1 = transformer.transform(å…¨å±€_å·¦, å…¨å±€_ä¸‹)
        lon2, lat2 = transformer.transform(å…¨å±€_å³, å…¨å±€_ä¸Š)
        print(f"\nğŸ“ ç»çº¬åº¦èŒƒå›´:")
        print(f"   ç»åº¦: {lon1:.6f}Â° ~ {lon2:.6f}Â°")
        print(f"   çº¬åº¦: {lat1:.6f}Â° ~ {lat2:.6f}Â°")
    
    return {
        'å·¦': å…¨å±€_å·¦,
        'å³': å…¨å±€_å³,
        'ä¸Š': å…¨å±€_ä¸Š,
        'ä¸‹': å…¨å±€_ä¸‹,
        'crs': åŸºå‡†_crs,
        'åˆ†è¾¨ç‡': åŸºå‡†_åˆ†è¾¨ç‡,
        'æœ‰æ•ˆTIF': æœ‰æ•ˆTIF
    }


def ç”ŸæˆåŸºå‡†åœ°å›¾(èŒƒå›´ä¿¡æ¯, shpè·¯å¾„, é™é‡‡æ ·å› å­=4):
    """ç”Ÿæˆè¦†ç›–å…¨éƒ¨èŒƒå›´çš„åŸºå‡†è€•åœ°åœ°å›¾"""
    
    print(f"\nğŸ“ è¯»å–SHPæ–‡ä»¶: {os.path.basename(shpè·¯å¾„)}")
    gdf = gpd.read_file(shpè·¯å¾„)
    print(f"   å‡ ä½•æ•°é‡: {len(gdf)}")
    print(f"   SHPåæ ‡ç³»: {gdf.crs}")
    
    # è½¬æ¢åæ ‡ç³»
    if gdf.crs != èŒƒå›´ä¿¡æ¯['crs'] and èŒƒå›´ä¿¡æ¯['crs'] is not None:
        print(f"   è½¬æ¢åæ ‡ç³»: {gdf.crs} -> {èŒƒå›´ä¿¡æ¯['crs']}")
        gdf = gdf.to_crs(èŒƒå›´ä¿¡æ¯['crs'])
    
    # è®¡ç®—åŸºå‡†åœ°å›¾å°ºå¯¸
    å…¨å±€å®½åº¦_ç±³ = èŒƒå›´ä¿¡æ¯['å³'] - èŒƒå›´ä¿¡æ¯['å·¦']
    å…¨å±€é«˜åº¦_ç±³ = èŒƒå›´ä¿¡æ¯['ä¸Š'] - èŒƒå›´ä¿¡æ¯['ä¸‹']
    
    æ–°åˆ†è¾¨ç‡ = èŒƒå›´ä¿¡æ¯['åˆ†è¾¨ç‡'] * é™é‡‡æ ·å› å­
    æ–°å®½åº¦ = int(å…¨å±€å®½åº¦_ç±³ / æ–°åˆ†è¾¨ç‡)
    æ–°é«˜åº¦ = int(å…¨å±€é«˜åº¦_ç±³ / æ–°åˆ†è¾¨ç‡)
    
    print(f"\nğŸ“° åŸºå‡†åœ°å›¾å‚æ•°:")
    print(f"   è¦†ç›–èŒƒå›´: {å…¨å±€å®½åº¦_ç±³:.1f}m x {å…¨å±€é«˜åº¦_ç±³:.1f}m")
    print(f"   åŸå§‹åˆ†è¾¨ç‡: {èŒƒå›´ä¿¡æ¯['åˆ†è¾¨ç‡']:.4f} m/åƒç´ ")
    print(f"   é™é‡‡æ ·å› å­: {é™é‡‡æ ·å› å­}x")
    print(f"   æ–°åˆ†è¾¨ç‡: {æ–°åˆ†è¾¨ç‡:.4f} m/åƒç´ ")
    print(f"   åœ°å›¾å°ºå¯¸: {æ–°å®½åº¦} x {æ–°é«˜åº¦} åƒç´ ")
    print(f"   é¢„è®¡å¤§å°: {æ–°å®½åº¦ * æ–°é«˜åº¦ / (1024*1024):.1f} MB")
    
    # åˆ›å»ºåœ°ç†å˜æ¢
    æ–°transform = Affine(æ–°åˆ†è¾¨ç‡, 0, èŒƒå›´ä¿¡æ¯['å·¦'], 0, -æ–°åˆ†è¾¨ç‡, èŒƒå›´ä¿¡æ¯['ä¸Š'])
    
    print(f"\nğŸ”„ ç”ŸæˆåŸºå‡†è€•åœ°åœ°å›¾...")
    åŸºå‡†è€•åœ°åœ°å›¾ = geometry_mask(
        gdf.geometry,
        out_shape=(æ–°é«˜åº¦, æ–°å®½åº¦),
        transform=æ–°transform,
        invert=True  # True=è€•åœ°ä¸º1
    ).astype(np.uint8)
    
    è€•åœ°åƒç´ æ•° = np.sum(åŸºå‡†è€•åœ°åœ°å›¾)
    è€•åœ°æ¯”ä¾‹ = np.mean(åŸºå‡†è€•åœ°åœ°å›¾) * 100
    
    print(f"   âœ… ç”Ÿæˆå®Œæˆ!")
    print(f"   å®é™…å¤§å°: {åŸºå‡†è€•åœ°åœ°å›¾.nbytes / (1024*1024):.1f} MB")
    print(f"   è€•åœ°åƒç´ æ•°: {è€•åœ°åƒç´ æ•°:,}")
    print(f"   è€•åœ°æ¯”ä¾‹: {è€•åœ°æ¯”ä¾‹:.2f}%")
    
    return åŸºå‡†è€•åœ°åœ°å›¾, æ–°transform


def ä¿å­˜PKL(åŸºå‡†è€•åœ°åœ°å›¾, transform, èŒƒå›´ä¿¡æ¯, shpè·¯å¾„, è¾“å‡ºè·¯å¾„):
    """ä¿å­˜åŸºå‡†æ•°æ®åˆ°PKLæ–‡ä»¶"""
    
    print(f"\nğŸ’¾ ä¿å­˜åŸºå‡†æ•°æ®...")
    
    # å¤‡ä»½æ—§æ–‡ä»¶
    if os.path.exists(è¾“å‡ºè·¯å¾„):
        å¤‡ä»½è·¯å¾„ = è¾“å‡ºè·¯å¾„.replace('.pkl', f'_å¤‡ä»½_{datetime.now().strftime("%Y%m%d_%H%M%S")}.pkl')
        import shutil
        shutil.copy(è¾“å‡ºè·¯å¾„, å¤‡ä»½è·¯å¾„)
        print(f"   æ—§æ–‡ä»¶å·²å¤‡ä»½: {os.path.basename(å¤‡ä»½è·¯å¾„)}")
    
    æ•°æ® = {
        'ä¿å­˜æ—¶é—´': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'åŸºå‡†å¹´ä»½': 'è®­ç»ƒæ•°æ®å¹´ä»½',
        'åŸºå‡†shpæ–‡ä»¶': os.path.basename(shpè·¯å¾„),
        'åŸºå‡†è€•åœ°åœ°å›¾': åŸºå‡†è€•åœ°åœ°å›¾,
        'åœ°ç†å˜æ¢': {
            'a': transform.a,
            'b': transform.b,
            'c': transform.c,
            'd': transform.d,
            'e': transform.e,
            'f': transform.f
        },
        'crs': str(èŒƒå›´ä¿¡æ¯['crs']),
        'åƒç´ åˆ†è¾¨ç‡_ç±³': abs(transform.a),
        'è¦†ç›–èŒƒå›´': {
            'å·¦': èŒƒå›´ä¿¡æ¯['å·¦'],
            'å³': èŒƒå›´ä¿¡æ¯['å³'],
            'ä¸Š': èŒƒå›´ä¿¡æ¯['ä¸Š'],
            'ä¸‹': èŒƒå›´ä¿¡æ¯['ä¸‹']
        },
        'è®­ç»ƒå›¾åƒåˆ—è¡¨': [os.path.basename(f) for f in èŒƒå›´ä¿¡æ¯['æœ‰æ•ˆTIF']]
    }
    
    with open(è¾“å‡ºè·¯å¾„, 'wb') as f:
        pickle.dump(æ•°æ®, f)
    
    æ–‡ä»¶å¤§å° = os.path.getsize(è¾“å‡ºè·¯å¾„) / (1024*1024)
    print(f"   âœ… ä¿å­˜å®Œæˆ: {è¾“å‡ºè·¯å¾„}")
    print(f"   æ–‡ä»¶å¤§å°: {æ–‡ä»¶å¤§å°:.1f} MB")
    
    return æ•°æ®


def éªŒè¯PKL(pklè·¯å¾„):
    """éªŒè¯ç”Ÿæˆçš„PKLæ–‡ä»¶"""
    
    print(f"\nğŸ” éªŒè¯PKLæ–‡ä»¶...")
    
    with open(pklè·¯å¾„, 'rb') as f:
        æ•°æ® = pickle.load(f)
    
    print(f"   ä¿å­˜æ—¶é—´: {æ•°æ®['ä¿å­˜æ—¶é—´']}")
    print(f"   SHPæ–‡ä»¶: {æ•°æ®['åŸºå‡†shpæ–‡ä»¶']}")
    print(f"   CRS: {æ•°æ®['crs']}")
    print(f"   åƒç´ åˆ†è¾¨ç‡: {æ•°æ®['åƒç´ åˆ†è¾¨ç‡_ç±³']:.4f} m")
    
    åœ°å›¾ = æ•°æ®['åŸºå‡†è€•åœ°åœ°å›¾']
    print(f"   åœ°å›¾å°ºå¯¸: {åœ°å›¾.shape[1]} x {åœ°å›¾.shape[0]} åƒç´ ")
    print(f"   è€•åœ°åƒç´ : {np.sum(åœ°å›¾):,}")
    
    èŒƒå›´ = æ•°æ®['è¦†ç›–èŒƒå›´']
    print(f"   è¦†ç›–èŒƒå›´:")
    print(f"      X: {èŒƒå›´['å·¦']:.2f} ~ {èŒƒå›´['å³']:.2f}")
    print(f"      Y: {èŒƒå›´['ä¸‹']:.2f} ~ {èŒƒå›´['ä¸Š']:.2f}")
    
    # è½¬æ¢ä¸ºç»çº¬åº¦
    from pyproj import Transformer
    transformer = Transformer.from_crs(æ•°æ®['crs'], 'EPSG:4326', always_xy=True)
    lon1, lat1 = transformer.transform(èŒƒå›´['å·¦'], èŒƒå›´['ä¸‹'])
    lon2, lat2 = transformer.transform(èŒƒå›´['å³'], èŒƒå›´['ä¸Š'])
    print(f"   ç»çº¬åº¦èŒƒå›´:")
    print(f"      ç»åº¦: {lon1:.6f}Â° ~ {lon2:.6f}Â°")
    print(f"      çº¬åº¦: {lat1:.6f}Â° ~ {lat2:.6f}Â°")
    
    print(f"   è®­ç»ƒå›¾åƒ: {len(æ•°æ®['è®­ç»ƒå›¾åƒåˆ—è¡¨'])} ä¸ª")
    for i, æ–‡ä»¶å in enumerate(æ•°æ®['è®­ç»ƒå›¾åƒåˆ—è¡¨'], 1):
        print(f"      [{i:2d}] {æ–‡ä»¶å}")


def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ”§ é‡æ–°ç”ŸæˆåŸºå‡†æ•°æ®PKLæ–‡ä»¶")
    print("=" * 60)
    print(f"ğŸ“‚ TIFç›®å½•: {TIFç›®å½•}")
    print(f"ğŸ“‚ SHPæ–‡ä»¶: {SHPè·¯å¾„}")
    print(f"ğŸ“‚ è¾“å‡ºæ–‡ä»¶: {è¾“å‡ºPKLè·¯å¾„}")
    
    # 1. æ‰«æTIFæ–‡ä»¶
    tifåˆ—è¡¨ = é€’å½’æ‰«æTIF(TIFç›®å½•)
    if not tifåˆ—è¡¨:
        print("âŒ æœªæ‰¾åˆ°ä»»ä½•TIFæ–‡ä»¶!")
        return
    
    print(f"\nâœ… æ‰¾åˆ° {len(tifåˆ—è¡¨)} ä¸ªTIFæ–‡ä»¶")
    
    # 2. æ£€æŸ¥SHPæ–‡ä»¶
    if not os.path.exists(SHPè·¯å¾„):
        print(f"âŒ SHPæ–‡ä»¶ä¸å­˜åœ¨: {SHPè·¯å¾„}")
        return
    
    # 3. è®¡ç®—è”åˆèŒƒå›´
    èŒƒå›´ä¿¡æ¯ = è®¡ç®—è”åˆèŒƒå›´(tifåˆ—è¡¨)
    
    if èŒƒå›´ä¿¡æ¯['crs'] is None:
        print("âŒ æ— æ³•è·å–åæ ‡ç³»ä¿¡æ¯!")
        return
    
    # 4. ç”ŸæˆåŸºå‡†åœ°å›¾
    åŸºå‡†è€•åœ°åœ°å›¾, transform = ç”ŸæˆåŸºå‡†åœ°å›¾(èŒƒå›´ä¿¡æ¯, SHPè·¯å¾„, é™é‡‡æ ·å› å­)
    
    # 5. ä¿å­˜PKL
    ä¿å­˜PKL(åŸºå‡†è€•åœ°åœ°å›¾, transform, èŒƒå›´ä¿¡æ¯, SHPè·¯å¾„, è¾“å‡ºPKLè·¯å¾„)
    
    # 6. éªŒè¯
    éªŒè¯PKL(è¾“å‡ºPKLè·¯å¾„)
    
    print("\n" + "=" * 60)
    print("ğŸ‰ å®Œæˆï¼ç°åœ¨å¯ä»¥æµ‹è¯•å›¾å½¢ç•Œé¢äº†ã€‚")
    print("=" * 60)


if __name__ == "__main__":
    main()
