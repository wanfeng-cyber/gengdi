"""
高精度颜色识别集成方案
将高精度颜色识别模块集成到耕地分析系统中
"""

import numpy as np
import cv2

# 集成方案说明
集成说明 = """
# 高精度颜色识别集成方案

## 1. 耕地分析系统.py - 主要集成文件

### 需要修改的位置：第1084-1119行

原始代码：
```python
# ✅ 颜色识别逻辑（替代AI预测）
# 获取去年块掩码
去年块掩码 = 耕地掩码[y_start:y_end, x_start:x_end]
去年是耕地 = 去年块掩码 > 0.5

# 颜色识别：棕色耕地 或 绿色耕地
块_uint8 = (块 * 255).astype(np.uint8) if 块.max() <= 1.0 else 块.astype(np.uint8)
R, G, B = 块_uint8[:,:,0], 块_uint8[:,:,1], 块_uint8[:,:,2]
...
```

替换为：
```python
# ✅ 颜色识别逻辑（替代AI预测）
# 获取去年块掩码
去年块掩码 = 耕地掩码[y_start:y_end, x_start:x_end]
去年是耕地 = 去年块掩码 > 0.5

# 使用高精度颜色识别
try:
    # 确保块是RGB格式且值在0-255之间
    if 块.max() <= 1.0:
        块_rgb = (块 * 255).astype(np.uint8)
    else:
        块_rgb = 块.astype(np.uint8)

    # 导入并使用高精度识别器
    from 高精度颜色识别 import 高精度颜色识别器
    if not hasattr(self, '_高精度识别器'):
        self._高精度识别器 = 高精度颜色识别器()

    # 使用高精度多方法融合识别
    今年疑似耕地 = self._高精度识别器.多方法融合(块_rgb, 去年块掩码) > 0.5

    print(f"  ✅ 使用高精度颜色识别（分辨率优化）")

except ImportError:
    print(f"  ⚠️ 高精度识别模块不可用，使用基础识别")
    # 备用：基础颜色识别
    块_uint8 = (块 * 255).astype(np.uint8) if 块.max() <= 1.0 else 块.astype(np.uint8)
    R, G, B = 块_uint8[:,:,0], 块_uint8[:,:,1], 块_uint8[:,:,2]

    # 过滤黑边
    不是黑边 = (R.astype(np.float32) + G.astype(np.float32) + B.astype(np.float32)) > 10

    # 棕色耕地识别
    棕色指数 = R.astype(np.float32) - B.astype(np.float32)
    是棕色耕地 = 棕色指数 > 25

    # 绿色耕地识别
    绿色指数 = G.astype(np.float32) - R.astype(np.float32)
    是绿色耕地 = 绿色指数 > 15

    # 排除纯灰色
    亮度 = (R + G + B) / 3.0
    色差 = np.maximum(np.abs(R.astype(np.float32) - 亮度),
                   np.maximum(np.abs(G.astype(np.float32) - 亮度),
                            np.abs(B.astype(np.float32) - 亮度)))
    不是纯灰色 = 色差 > 10

    今年疑似耕地 = (是棕色耕地 | 是绿色耕地) & 不是纯灰色 & 不是黑边
```

## 2. 耕地识别模型训练(16)(1).py) - 训练时增强

### 在生成训练数据时应用高精度识别（第325-332行）

在 `从TIF和Shapefile生成训练数据` 函数中添加：

```python
# 在生成标签块后，可以使用高精度识别进行增强
# 位置：第331行 标签块 = (~标签块).astype(np.float32) 之后

# 可选：使用高精度识别增强标签（如果有去年的RGB数据）
# if 有去年RGB数据:
#     try:
#         from 高精度颜色识别 import 高精度颜色识别器
#         识别器 = 高精度颜色识别器()
#         增强标签 = 识别器.多方法融合(影像块, 标签块)
#         标签块 = np.maximum(标签块, 增强标签)  # 取并集
#     except:
#         pass
```

## 3. 耕地分析工具_图形界面.py) - 自动生效

图形界面调用耕地分析系统的功能，高精度识别会自动生效，无需修改。

## 4. 系统优化建议

### 4.1 添加分辨率自适应

在 `耕地分析系统.py` 的 `使用模型预测耕地_大图` 方法开头添加：

```python
# 在第904行读取图像后，计算实际分辨率
with rasterio.open(tif路径) as src:
    像素分辨率 = abs(src.transform.a)
    print(f"  📐 图像分辨率: {像素分辨率:.3f}米/像素")

    # 根据分辨率选择处理策略
    if 像素分辨率 <= 0.1:
        print("  ✅ 超高分辨率图像（<0.1m/像素），启用高精度模式")
    elif 像素分辨率 <= 0.2:
        print("  ✅ 高分辨率图像（0.1-0.2m/像素），启用精细模式")
    elif 像素分辨率 <= 0.5:
        print("  ⚠️ 中高分辨率图像（0.2-0.5m/像素），使用标准模式")
    else:
        print("  ❌ 低分辨率图像（>0.5m/像素），精度受限")
```

### 4.2 添加进度显示

在高精度识别过程中添加更详细的进度信息：

```python
# 在第1171行附近添加
print(f"  🧠 使用高精度颜色识别: 自适应阈值 + 颜色聚类 + LAB空间检测")
```

## 5. 部署步骤

1. 将 高精度颜色识别.py 放在与其他文件相同的目录
2. 按照上述说明修改 耕地分析系统.py
3. 确保安装了必要的依赖：scikit-learn
4. 测试运行，查看控制台输出确认高精度识别已启用

## 6. 性能优化

- 高精度识别会增加计算时间，但显著提升精度
- 对于大图，建议只在边界区域使用高精度识别
- 可以通过修改 高精度颜色识别.py 中的参数表来优化性能

## 7. 预期效果

- 5-10厘米分辨率：RMSE 可达 0.1-0.2米
- 10-20厘米分辨率：RMSE 可达 0.2-0.3米
- 20-50厘米分辨率：RMSE 可达 0.3-0.5米
"""

print(集成说明)