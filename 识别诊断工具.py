"""
耕地识别诊断工具
用于验证和调试识别结果的准确性
"""
import numpy as np
import cv2
import rasterio
import matplotlib.pyplot as plt
from 高精度颜色识别 import 高精度颜色识别器
import os

def 诊断识别结果(tif_path, 像素分辨率, 预期面积_亩=12.6):
    """
    诊断识别结果，分析为什么面积与预期不符

    Args:
        tif_path: TIF图像路径
        像素分辨率: 图像的像素分辨率（米/像素）
        预期面积_亩: 预期的真实耕地面积（亩）
    """
    print("="*60)
    print("耕地识别诊断工具")
    print("="*60)

    # 读取图像
    with rasterio.open(tif_path) as src:
        图像数据 = src.read()
        if 图像数据.shape[0] <= 4:
            图像 = np.transpose(图像数据[:3], (1, 2, 0))
        else:
            图像 = 图像数据[1:4]

    # 归一化
    if 图像.max() > 1.0:
        图像 = 图像.astype(np.float32) / 255.0

    print(f"\n📊 图像信息:")
    print(f"   文件: {os.path.basename(tif_path)}")
    print(f"   尺寸: {图像.shape[:2]}")
    print(f"   数据范围: {图像.min():.3f} - {图像.max():.3f}")
    print(f"   像素分辨率: {像素分辨率:.6f} 米/像素")

    # 计算预期像素数
    预期面积_平方米 = 预期面积_亩 * 666.67
    预期像素数 = 预期面积_平方米 / (像素分辨率 * 像素分辨率)
    print(f"\n📐 预期值:")
    print(f"   预期面积: {预期面积_亩} 亩 ({预期面积_平方米:.0f} 平方米)")
    print(f"   预期像素数: {预期像素数:,.0f}")

    # 使用不同阈值进行测试
    识别器 = 高精度颜色识别器()

    # 测试区域（使用中心区域）
    h, w = 图像.shape[:2]
    测试块 = 图像[h//4:3*h//4, w//4:3*w//4]

    print(f"\n🔍 测试区域: {测试块.shape[:2]} (中心区域)")

    # 1. 使用默认阈值识别
    默认掩码 = 识别器.多方法融合(测试块)
    默认像素数 = np.sum(默认掩码 > 0.5)
    默认面积 = 默认像素数 * (像素分辨率 * 像素分辨率) / 666.67

    print(f"\n📊 当前识别结果:")
    print(f"   识别像素数: {默认像素数:,.0f}")
    print(f"   识别面积: {默认面积:.2f} 亩")
    print(f"   偏差: {(默认面积 - 预期面积_亩)/预期面积_亩*100:.1f}%")

    # 2. 分析颜色分布
    块_uint8 = (测试块 * 255).astype(np.uint8)
    R, G, B = 块_uint8[:,:,0], 块_uint8[:,:,1], 块_uint8[:,:,2]

    # 计算各种颜色的像素数
    总像素 = 测试块.shape[0] * 测试块.shape[1]

    # 绿色（植被）
    绿色条件 = (G > R * 1.2) & (G > B * 1.2) & (G > 60)
    绿色像素 = np.sum(绿色条件)

    # 棕色（土壤）
    棕色条件 = (R > G * 1.1) & (R > B * 1.0) & (R > 60)
    棕色像素 = np.sum(棕色条件)

    # 黄色（干草）
    黄色条件 = (R > 100) & (G > 100) & (B < 120) & (np.abs(R - G) < 30)
    黄色像素 = np.sum(黄色条件)

    # 水体
    水体条件 = (B > R * 1.2) & (B > G * 1.2) & (B > 60)
    水体像素 = np.sum(水体条件)

    print(f"\n🎨 颜色分布分析:")
    print(f"   绿色（植被）: {绿色像素:,} 像素 ({绿色像素/总像素*100:.1f}%)")
    print(f"   棕色（土壤）: {棕色像素:,} 像素 ({棕色像素/总像素*100:.1f}%)")
    print(f"   黄色（干草）: {黄色像素:,} 像素 ({黄色像素/总像素*100:.1f}%)")
    print(f"   蓝色（水体）: {水体像素:,} 像素 ({水体像素/总像素*100:.1f}%)")

    # 3. 测试不同严格程度的阈值
    print(f"\n🔧 阈值测试:")

    # 测试更严格的绿色阈值
    严格绿色条件 = (G > R * 1.5) & (G > B * 1.5) & (G > 80)
    严格绿色像素 = np.sum(严格绿色条件)

    # 测试更严格的棕色阈值
    严格棕色条件 = (R > G * 1.3) & (R > B * 1.2) & (R > 80)
    严格棕色像素 = np.sum(严格棕色条件)

    # 合并严格条件
    严格耕地掩码 = (严格绿色条件 | 严格棕色条件 | 黄色条件) & ~水体条件
    严格像素数 = np.sum(严格耕地掩码)
    严格面积 = 严格像素数 * (像素分辨率 * 像素分辨率) / 666.67

    print(f"   严格阈值识别:")
    print(f"     像素数: {严格像素数:,.0f}")
    print(f"     面积: {严格面积:.2f} 亩")
    print(f"     偏差: {(严格面积 - 预期面积_亩)/预期面积_亩*100:.1f}%")

    # 4. 建议的调整方案
    print(f"\n💡 诊断结果和建议:")

    if 默认面积 > 预期面积_亩 * 1.05:
        print("   ❌ 识别面积偏大，建议：")
        print("      1. 增加绿色阈值（从1.2提高到1.4-1.5）")
        print("      2. 增加棕色阈值（从1.1提高到1.2-1.3）")
        print("      3. 增加最小亮度要求（从60提高到80）")
        if 严格面积 < 默认面积:
            print(f"      4. 使用严格阈值可减少 {(默认面积-严格面积):.2f} 亩")

    elif 默认面积 < 预期面积_亩 * 0.95:
        print("   ❌ 识别面积偏小，建议：")
        print("      1. 降低绿色阈值（从1.2降低到1.1）")
        print("      2. 降低棕色阈值（从1.1降低到1.0）")
        print("      3. 减少最小亮度要求（从60降低到40）")

    else:
        print("   ✅ 识别面积在预期范围内")

    # 5. 形态学处理建议
    print(f"\n🔧 形态学处理建议:")
    print("   1. 使用腐蚀操作去除边缘噪声（3x3核）")
    print("   2. 使用开运算去除小的孤立区域（最小50像素）")
    print("   3. 使用闭运算填充小的空洞（最小30像素）")

    print("\n" + "="*60)

def 测试两个图像():
    """测试去年的qunian.tif和今年的jinnian.tif"""
    # 去年图像
    if os.path.exists("qunian.tif"):
        print("\n测试去年图像: qunian.tif")
        诊断识别结果("qunian.tif", 0.218000)

    # 今年图像
    if os.path.exists("jinnian.tif"):
        print("\n测试今年图像: jinnian.tif")
        诊断识别结果("jinnian.tif", 0.054500)

if __name__ == "__main__":
    测试两个图像()