"""
è¯Šæ–­ä¸ºä»€ä¹ˆé¢ç§¯è®¡ç®—ç»“æœä¸é¢„æœŸä¸ç¬¦
"""
import rasterio
import numpy as np
import pickle
import os

def è¯Šæ–­é¢ç§¯è®¡ç®—():
    print("="*60)
    print("é¢ç§¯è®¡ç®—è¯Šæ–­å·¥å…·")
    print("="*60)

    # æ£€æŸ¥åŸºå‡†æ•°æ®
    if os.path.exists("åŸºå‡†æ•°æ®.pkl"):
        with open("åŸºå‡†æ•°æ®.pkl", 'rb') as f:
            åŸºå‡†ä¿¡æ¯ = pickle.load(f)

        print("\nğŸ“Š åŸºå‡†æ•°æ®ä¿¡æ¯:")
        print(f"   åŸºå‡†å¹´ä»½: {åŸºå‡†ä¿¡æ¯.get('åŸºå‡†å¹´ä»½', 'N/A')}")
        print(f"   åƒç´ åˆ†è¾¨ç‡: {åŸºå‡†ä¿¡æ¯.get('åƒç´ åˆ†è¾¨ç‡_ç±³', 'N/A')} ç±³/åƒç´ ")
        print(f"   åŸºå‡†åœ°å›¾å°ºå¯¸: {åŸºå‡†ä¿¡æ¯['åŸºå‡†è€•åœ°åœ°å›¾'].shape}")

        # è®¡ç®—åŸºå‡†æ•°æ®çš„æ€»è€•åœ°é¢ç§¯
        åŸºå‡†åœ°å›¾ = åŸºå‡†ä¿¡æ¯['åŸºå‡†è€•åœ°åœ°å›¾']
        åŸºå‡†è€•åœ°åƒç´  = np.sum(åŸºå‡†åœ°å›¾ > 0.5)
        åŸºå‡†åƒç´ åˆ†è¾¨ç‡ = åŸºå‡†ä¿¡æ¯.get('åƒç´ åˆ†è¾¨ç‡_ç±³', 0.218)
        åŸºå‡†å•åƒç´ é¢ç§¯ = åŸºå‡†åƒç´ åˆ†è¾¨ç‡ * åŸºå‡†åƒç´ åˆ†è¾¨ç‡
        åŸºå‡†æ€»é¢ç§¯ = åŸºå‡†è€•åœ°åƒç´  * åŸºå‡†å•åƒç´ é¢ç§¯ / 666.67

        print(f"\n   åŸºå‡†è€•åœ°åƒç´ æ•°: {åŸºå‡†è€•åœ°åƒç´ :,}")
        print(f"   å•åƒç´ é¢ç§¯: {åŸºå‡†å•åƒç´ é¢ç§¯:.6f} å¹³æ–¹ç±³")
        print(f"   åŸºå‡†æ€»é¢ç§¯: {åŸºå‡†æ€»é¢ç§¯:.2f} äº©")

    # æ£€æŸ¥jinnian.tif
    if os.path.exists("jinnian.tif"):
        with rasterio.open("jinnian.tif") as src:
            print(f"\nğŸ“Š jinnian.tif ä¿¡æ¯:")
            print(f"   å°ºå¯¸: {src.width}x{src.height}")
            print(f"   åæ ‡ç³»: {src.crs}")
            print(f"   åƒç´ åˆ†è¾¨ç‡: {abs(src.transform.a):.6f} ç±³/åƒç´ ")

            # è¯»å–ä¸€å°å—åŒºåŸŸè¿›è¡Œæµ‹è¯•
            window = rasterio.windows.Window(0, 0, min(256, src.width), min(256, src.height))
            data = src.read(window=window)

            if data.shape[0] <= 4:
                å›¾åƒ = np.transpose(data[:3], (1, 2, 0))
            else:
                å›¾åƒ = data[1:4]

            print(f"   æ•°æ®èŒƒå›´: {å›¾åƒ.min():.3f} - {å›¾åƒ.max():.3f}")

            # ç®€å•çš„é¢œè‰²åˆ†æ
            å›¾åƒ_uint8 = (å›¾åƒ * 255).astype(np.uint8) if å›¾åƒ.max() <= 1 else å›¾åƒ.astype(np.uint8)
            R, G, B = å›¾åƒ_uint8[:,:,0], å›¾åƒ_uint8[:,:,1], å›¾åƒ_uint8[:,:,2]

            # ä¼°ç®—å¯èƒ½çš„è€•åœ°åƒç´ 
            ç»¿è‰²åƒç´  = np.sum((G > R * 1.2) & (G > B * 1.2))
            æ£•è‰²åƒç´  = np.sum((R > G * 1.1) & (R > B * 1.1))
            æ€»åƒç´  = å›¾åƒ.shape[0] * å›¾åƒ.shape[1]

            print(f"\n   æµ‹è¯•åŒºåŸŸé¢œè‰²åˆ†æ:")
            print(f"   ç»¿è‰²åƒç´ : {ç»¿è‰²åƒç´ :,} ({ç»¿è‰²åƒç´ /æ€»åƒç´ *100:.1f}%)")
            print(f"   æ£•è‰²åƒç´ : {æ£•è‰²åƒç´ :,} ({æ£•è‰²åƒç´ /æ€»åƒç´ *100:.1f}%)")

            # ä¼°ç®—å…¨å›¾è€•åœ°é¢ç§¯ï¼ˆä½¿ç”¨ä¿å®ˆæ¯”ä¾‹ï¼‰
            ä¼°è®¡è€•åœ°æ¯”ä¾‹ = min(0.4, (ç»¿è‰²åƒç´  + æ£•è‰²åƒç´ ) / æ€»åƒç´  * 1.5)  # ä¿å®ˆä¼°è®¡
            å…¨å›¾åƒç´  = src.width * src.height
            ä¼°è®¡è€•åœ°åƒç´  = å…¨å›¾åƒç´  * ä¼°è®¡è€•åœ°æ¯”ä¾‹
            å•åƒç´ é¢ç§¯ = abs(src.transform.a) * abs(src.transform.e)
            ä¼°è®¡é¢ç§¯ = ä¼°è®¡è€•åœ°åƒç´  * å•åƒç´ é¢ç§¯ / 666.67

            print(f"\n   ä¼°è®¡å…¨å›¾:")
            print(f"   æ€»åƒç´ æ•°: {å…¨å›¾åƒç´ :,}")
            print(f"   ä¼°è®¡è€•åœ°æ¯”ä¾‹: {ä¼°è®¡è€•åœ°æ¯”ä¾‹*100:.1f}%")
            print(f"   ä¼°è®¡è€•åœ°åƒç´ : {ä¼°è®¡è€•åœ°åƒç´ :,.0f}")
            print(f"   ä¼°è®¡è€•åœ°é¢ç§¯: {ä¼°è®¡é¢ç§¯:.2f} äº©")

    # æ£€æŸ¥qunian.tif
    if os.path.exists("qunian.tif"):
        with rasterio.open("qunian.tif") as src:
            print(f"\nğŸ“Š qunian.tif ä¿¡æ¯:")
            print(f"   å°ºå¯¸: {src.width}x{src.height}")
            print(f"   åæ ‡ç³»: {src.crs}")
            print(f"   åƒç´ åˆ†è¾¨ç‡: {abs(src.transform.a):.6f} ç±³/åƒç´ ")

    print("\n" + "="*60)
    print("\nğŸ’¡ åˆ†æç»“æœ:")

    # è®¡ç®—æœŸæœ›çš„åƒç´ æ•°
    é¢„æœŸé¢ç§¯ = 12.6  # äº©
    é¢„æœŸå¹³æ–¹ç±³ = é¢„æœŸé¢ç§¯ * 666.67

    if os.path.exists("jinnian.tif"):
        with rasterio.open("jinnian.tif") as src:
            åˆ†è¾¨ç‡ = abs(src.transform.a)
            é¢„æœŸåƒç´ æ•° = é¢„æœŸå¹³æ–¹ç±³ / (åˆ†è¾¨ç‡ * åˆ†è¾¨ç‡)
            å…¨å›¾åƒç´  = src.width * src.height
            é¢„æœŸæ¯”ä¾‹ = é¢„æœŸåƒç´ æ•° / å…¨å›¾åƒç´ 

            print(f"\n   å¯¹äºjinnian.tif:")
            print(f"   è¦è¾¾åˆ°{é¢„æœŸé¢ç§¯}äº©ï¼Œéœ€è¦:")
            print(f"   - è€•åœ°åƒç´ æ•°: {é¢„æœŸåƒç´ æ•°:,.0f}")
            print(f"   - è€•åœ°æ¯”ä¾‹: {é¢„æœŸæ¯”ä¾‹*100:.1f}%")
            print(f"   - ç›¸å½“äºæ¯256x256å—åº”æœ‰: {é¢„æœŸåƒç´ æ•°/(å…¨å›¾åƒç´ /256/256):.0f} è€•åœ°åƒç´ ")

    print("\n" + "="*60)

if __name__ == "__main__":
    è¯Šæ–­é¢ç§¯è®¡ç®—()