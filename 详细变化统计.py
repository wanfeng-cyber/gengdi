"""
详细的耕地变化统计
不仅显示净变化，还分别统计新增和减少的耕地
"""

def 计算详细变化(去年掩码, 今年掩码, 像素分辨率=0.218):
    """
    详细计算耕地的变化情况

    Returns:
        dict: 包含详细统计信息
    """
    import numpy as np

    # 确保掩码是二值的
    去年二值 = (去年掩码 > 0.5).astype(np.uint8)
    今年二值 = (今年掩码 > 0.5).astype(np.uint8)

    # 计算不同类型的变化
    # 1. 稳定耕地（两年都有）
    稳定耕地 = np.logical_and(去年二值, 今年二值)

    # 2. 新增耕地（去年没有，今年有）
    新增耕地 = np.logical_and(~去年二值, 今年二值)

    # 3. 减少耕地（去年有，今年没有）
    减少耕地 = np.logical_and(去年二值, ~今年二值)

    # 4. 非耕地（两年都没有）
    非耕地 = np.logical_and(~去年二值, ~今年二值)

    # 计算像素数
    去年像素数 = np.sum(去年二值)
    今年像素数 = np.sum(今年二值)
    稳定像素数 = np.sum(稳定耕地)
    新增像素数 = np.sum(新增耕地)
    减少像素数 = np.sum(减少耕地)

    # 转换为面积
    像素面积 = (像素分辨率 ** 2) / 666.67  # 平方米转亩

    去年面积 = 去年像素数 * 像素面积
    今年面积 = 今年像素数 * 像素面积
    稳定面积 = 稳定像素数 * 像素面积
    新增面积 = 新增像素数 * 像素面积
    减少面积 = 减少像素数 * 像素面积

    # 验证计算
    # 去年面积 = 稳定面积 + 减少面积
    # 今年面积 = 稳定面积 + 新增面积
    # 净变化 = 新增面积 - 减少面积

    return {
        '去年像素数': int(去年像素数),
        '今年像素数': int(今年像素数),
        '稳定像素数': int(稳定像素数),
        '新增像素数': int(新增像素数),
        '减少像素数': int(减少像素数),

        '去年面积_亩': 去年面积,
        '今年面积_亩': 今年面积,
        '稳定面积_亩': 稳定面积,
        '新增面积_亩': 新增面积,
        '减少面积_亩': 减少面积,
        '净变化_亩': 今年面积 - 去年面积,

        '新增掩码': 新增耕地.astype(np.float32),
        '减少掩码': 减少耕地.astype(np.float32),
        '稳定掩码': 稳定耕地.astype(np.float32)
    }

def 生成变化可视化(去年图像, 变化统计):
    """
    生成显示变化的三色可视化图像

    颜色方案：
    - 红色：新增耕地
    - 蓝色：减少耕地
    - 绿色：稳定耕地
    """
    import cv2
    import numpy as np

    # 创建RGB图像
    h, w = 去年图像.shape[:2]
    变化图像 = np.zeros((h, w, 3), dtype=np.uint8)

    # 使用去年图像作为背景（灰色）
    背景 = cv2.cvtColor(去年图像, cv2.COLOR_RGB2GRAY)
    变化图像[:,:,0] = 背景 * 0.5
    变化图像[:,:,1] = 背景 * 0.5
    变化图像[:,:,2] = 背景 * 0.5

    # 添加变化区域
    # 稳定耕地 - 绿色
    稳定掩码 = (变化统计['稳定掩码'] > 0.5)
    变化图像[稳定掩码] = [0, 255, 0]  # 纯绿色

    # 新增耕地 - 红色
    新增掩码 = (变化统计['新增掩码'] > 0.5)
    变化图像[新增掩码] = [255, 0, 0]  # 纯红色

    # 减少耕地 - 蓝色
    减少掩码 = (变化统计['减少掩码'] > 0.5)
    变化图像[减少掩码] = [0, 0, 255]  # 纯蓝色

    return 变化图像

def 显示详细统计(变化统计, 输出函数=print):
    """
    格式化输出详细的变化统计
    """
    输出函数("\n" + "="*60)
    输出函数("📊 详细耕地变化统计")
    输出_function("="*60)

    输出_function("\n📈 面积变化（亩）：")
    输出_function(f"   去年耕地: {变化统计['去年面积_亩']:.3f} 亩")
    输出_function(f"   今年耕地: {变化统计['今年面积_亩']:.3f} 亩")
    输出_function(f"   净变化: {变化统计['净变化_亩']:+.3f} 亩")

    输出_function("\n🔄 变化分解：")
    输出_function(f"   稳定耕地: {变化统计['稳定面积_亩']:.3f} 亩 ({变化统计['稳定像素数']:,} 像素)")
    输出_function(f"   新增耕地: +{变化统计['新增面积_亩']:.3f} 亩 ({变化统计['新增像素数']:,} 像素)")
    输出_function(f"   减少耕地: -{变化统计['减少面积_亩']:.3f} 亩 ({变化统计['减少像素数']:,} 像素)")

    输出_function("\n💡 变化说明：")
    if 变化统计['新增面积_亩'] > 0:
        输出_function(f"   ✅ 有新增耕地！新增了 {变化统计['新增面积_亩']:.3f} 亩")
    if 变化统计['减少面积_亩'] > 0:
        输出_function(f"   ❌ 有耕地减少！减少了 {变化统计['减少面积_亩']:.3f} 亩")

    if 变化统计['净变化_亩'] > 0:
        输出_function(f"\n📈 总体：耕地净增加 {变化统计['净变化_亩']:.3f} 亩")
    elif 变化统计['净变化_亩'] < 0:
        输出_function(f"\n📉 总体：耕地净减少 {abs(变化统计['净变化_亩']):.3f} 亩")
    else:
        输出_function(f"\n➡️ 总体：耕地面积保持不变")


# 创建集成代码
集成代码 = '''
# 在耕地分析工具_图形界面.py中，在显示分析结果后添加详细统计

# 导入功能
from 详细变化统计 import 计算详细变化, 显示详细统计, 生成变化可视化

# 在计算完去年和今年结果后（约第1260行后）：
if 去年耕地掩码_for_compare is not None and 耕地掩码 is not None:
    # 计算详细变化
    像素分辨率 = 基准像素分辨率 if 有基准数据 else 0.218
    变化统计 = 计算详细变化(去年耕地掩码_for_compare, 耕地掩码, 像素分辨率)

    # 显示详细统计
    显示详细统计(变化统计, self.输出结果)

    # 可选：生成变化可视化图像
    if hasattr(self, '显示变化可视化'):
        变化图像 = 生成变化可视化(今年图像, 变化统计)
        self.显示变化图像(变化图像)
'''

print("详细变化统计功能")
print("="*60)
print("\n这个功能将帮助您：")
print("1. 分别统计新增和减少的耕地面积")
print("2. 生成三色变化图（红色=新增，蓝色=减少，绿色=稳定）")
print("3. 更好地理解耕地变化的具体情况")
print("\n集成代码已生成，请按照说明添加到主程序中")

# 保存集成代码
with open("详细变化统计_集成代码.py", "w", encoding="utf-8") as f:
    f.write(集成代码)
print("\n✅ 集成代码已保存到：详细变化统计_集成代码.py")