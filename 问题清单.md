# 耕地分析工具 - 可视化交集问题清单

## 1. 问题描述

可视化函数报错"两张图没有经纬度交集"，导致无法显示双图对比。用户确认去年和今年的TIF文件是同一地点。

---

## 2. 用户环境

| 项目 | 路径 |
|------|------|
| 今年图像文件夹 | `C:\Users\jiao\Desktop\1(1)\1\jinnian` |
| 去年图像文件夹 | `C:\Users\jiao\Desktop\1(1)\1\qunian` |
| 基准PKL文件 | `耕地识别模型_基准数据.pkl` |
| 主程序文件 | `耕地分析工具_图形界面.py` |

---

## 3. 调试日志

```
🔍 可视化函数CRS比较:
   基准中央经线: CM 129E
   今年中央经线: CM 129E
   基准CRS与今年不同: False

🔍 去年图像范围: 左=594826.46, 下=5331174.59, 右=594984.68, 上=5331350.24
🔍 今年图像范围: 左=371424.14, 下=5331829.86, 右=371581.51, 上=5332006.96
🔍 计算交集: 左=594826.46, 下=5331829.86, 右=371581.51, 上=5331350.24

⚠️  两张图没有经纬度交集，只显示去年图像
```

---

## 4. 问题分析

### 4.1 数据矛盾
- 去年图像X坐标：约594000
- 今年图像X坐标：约371000
- **相差约22万米**，在同一投影下不可能是同一地点

### 4.2 但是
- 两图CRS都显示为 `CGCS2000 / 3-degree Gauss-Kruger CM 129E`
- 用户坚称两个文件夹的TIF是同一地点

### 4.3 可能原因
1. 程序读取的文件路径不是用户选择的那个（存在bug）
2. 两个TIF文件实际确实不是同一地点（用户认知错误）
3. TIF文件的CRS元数据有误

---

## 5. 待排查项

### 5.1 确认程序读取的文件路径
在代码第357行前添加调试：
```python
print(f"📂 去年文件路径: {self.去年图像路径}")
print(f"📂 今年文件路径: {self.今年图像路径}")
```

### 5.2 用工具直接检查TIF元数据
```python
import rasterio

# 检查今年图像
with rasterio.open("今年图像路径.tif") as src:
    print(f"Bounds: {src.bounds}")
    print(f"CRS: {src.crs}")

# 检查去年图像
with rasterio.open("去年图像路径.tif") as src:
    print(f"Bounds: {src.bounds}")
    print(f"CRS: {src.crs}")
```

### 5.3 用QGIS可视化确认
将两个TIF拖入QGIS，看是否在同一位置。

---

## 6. 相关代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| 可视化函数 | `耕地分析工具_图形界面.py` | 第338行 `显示耕地可视化` |
| 读取去年图像 | 同上 | 第357行 |
| 读取今年图像 | 同上 | 第365行 |
| 交集计算 | 同上 | 第439-442行 |
| 交集判断 | 同上 | 第451行 |

---

## 7. 交集计算逻辑（当前代码）

```python
# 第439-442行
交集_左 = max(去年_左, 今年_左)
交集_右 = min(去年_右, 今年_右)
交集_上 = min(去年_上, 今年_上)
交集_下 = max(去年_下, 今年_下)

# 第451行 - 判断是否有交集
有交集 = 交集_左 < 交集_右 and 交集_下 < 交集_上
```

当 `交集_左 > 交集_右` 时判定为无交集。

---

## 8. 历史上下文

1. 用户使用186个TIF训练了基准PKL（覆盖大范围）
2. 降采样因子从4x改为16x解决内存问题
3. 轮廓面积过滤阈值从100降到10兼容16x降采样
4. 之前有CRS不同（126E vs 129E）的问题，已通过WGS84转换解决
5. 当前问题是CRS相同但X坐标差距巨大

---

## 9. 建议修复方向

1. **先确认文件路径**：打印实际读取的路径
2. **如果路径正确但坐标不同**：说明TIF文件本身就不是同一地点
3. **如果路径被错误覆盖**：检查文件选择逻辑中是否有bug
