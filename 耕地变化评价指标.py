"""
耕地变化科学评价指标
针对垄作农业和耕地实际情况设计
"""

import numpy as np
import cv2

class 耕地变化评估器:
    """专业的耕地变化评估工具"""

    def 计算耕地边界变化(self, 去年掩码, 今年掩码, 像素分辨率):
        """
        计算耕地的边界变化
        这是最重要的指标
        """
        # 找到边界
        kernel = np.ones((3,3), np.uint8)

        # 提取边界（边缘检测）
        去年边界 = cv2.Canny((去年掩码 * 255).astype(np.uint8), 100, 200)
        今年边界 = cv2.Canny((今年掩码 * 255).astype(np.uint8), 100, 200)

        # 膨胀边界以计算变化带
        去年边界_expanded = cv2.dilate(去年边界, kernel, iterations=2)
        今年边界_expanded = cv2.dilate(今年边界, kernel, iterations=2)

        # 计算变化区域
        边界变化区域 = cv2.bitwise_xor(去年边界_expanded, 今年边界_expanded)
        变化像素数 = np.sum(边界变化区域 > 0)
        变化面积 = 变化像素数 * (像素分辨率 ** 2)

        # 计算平均边界偏移
        边界像素 = np.sum(今年边界 > 0)
        if 边界像素 > 0:
            平均偏移米 = 变化面积 / (2 * np.pi * np.sqrt(今年掩码.sum() / np.pi))
        else:
            平均偏移米 = 0

        return {
            '边界变化面积(平方米)': 变化面积,
            '边界变化面积(亩)': 变化面积 * 0.0015,
            '平均边界偏移(米)': 平均偏移米,
            '精度等级': self.评价边界精度(平均偏移米)
        }

    def 评价边界精度(self, 偏移米):
        """评价边界偏移的精度等级"""
        if 偏移米 < 0.1:
            return "S级 - 极高精度（<10厘米）"
        elif 偏移米 < 0.25:
            return "A级 - 高精度（10-25厘米）"
        elif 偏移米 < 0.5:
            return "B级 - 标准精度（25-50厘米）"
        elif 偏移米 < 1.0:
            return "C级 - 中等精度（50厘米-1米）"
        else:
            return "D级 - 低精度（>1米）"

    def 计算面积变化(self, 去年掩码, 今年掩码, 像素分辨率):
        """
        计算面积变化
        """
        # 计算新增区域
        新增区域 = (今年掩码 > 0.5) & (去年掩码 <= 0.5)
        减少区域 = (去年掩码 > 0.5) & (今年掩码 <= 0.5)

        # 转换为面积
        新增面积_m2 = np.sum(新增区域) * (像素分辨率 ** 2)
        减少面积_m2 = np.sum(减少区域) * (像素分辨率 ** 2)

        return {
            '新增面积(平方米)': 新增面积_m2,
            '新增面积(亩)': 新增面积_m2 * 0.0015,
            '减少面积(平方米)': 减少面积_m2,
            '减少面积(亩)': 减少面积_m2 * 0.0015,
            '净变化(亩)': (新增面积_m2 - 减少面积_m2) * 0.0015
        }

    def 检测边界变化类型(self, 去年掩码, 今年掩码, 像素分辨率):
        """
        分析边界变化的类型
        """
        # 计算四个方向的变化
        h, w = 去年掩码.shape

        # 上边界变化
        上边界去年 = np.any(去年掩码[:10, :] > 0.5, axis=0)
        上边界今年 = np.any(今年掩码[:10, :] > 0.5, axis=0)
        上变化米 = np.sum(np.abs(上边界去年.astype(int) - 上边界今年.astype(int))) * 像素分辨率

        # 下边界变化
        下边界去年 = np.any(去年掩码[-10:, :] > 0.5, axis=0)
        下边界今年 = np.any(今年掩码[-10:, :] > 0.5, axis=0)
        下变化米 = np.sum(np.abs(下边界去年.astype(int) - 下边界今年.astype(int))) * 像素分辨率

        # 左边界变化
        左边界去年 = np.any(去年掩码[:, :10] > 0.5, axis=0)
        左边界今年 = np.any(今年掩码[:, :10] > 0.5, axis=0)
        左变化米 = np.sum(np.abs(左边界去年.astype(int) - 左边界今年.astype(int))) * 像素分辨率

        # 右边界变化
        右边界去年 = np.any(去年掩码[:, -10:] > 0.5, axis=0)
        右边界今年 = np.any(今年掩码[:, -10:] > 0.5, axis=0)
        右变化米 = np.sum(np.abs(右边界去年.astype(int) - 右边界今年.astype(int))) * 像素分辨率

        return {
            '北边界变化(米)': 上变化米,
            '南边界变化(米)': 下变化米,
            '西边界变化(米)': 左变化米,
            '东边界变化(米)': 右变化米,
            '主要变化方向': self.判断主要变化方向(上变化米, 下变化米, 左变化米, 右变化米)
        }

    def 判断主要变化方向(self, 北, 南, 西, 东):
        """判断主要变化方向"""
        变化 = {'北': 北, '南': 南, '西': 西, '东': 东}
        max方向 = max(变化, key=变化.get)

        if 变化[max方向] < 0.1:
            return "无明显变化"

        return f"主要向{max方向}扩展/收缩"

    def 生成耕地变化报告(self, 去年掩码, 今年掩码, 像素分辨率):
        """
        生成完整的耕地变化报告
        """
        print("=" * 60)
        print("📊 耕地变化专业评估报告")
        print("=" * 60)

        # 1. 边界精度分析
        边界分析 = self.计算耕地边界变化(去年掩码, 今年掩码, 像素分辨率)
        print("\n🎯 边界精度分析:")
        print(f"  平均边界偏移: {边界分析['平均边界偏移(米)']:.3f} 米")
        print(f"  精度等级: {边界分析['精度等级']}")
        print(f"  边界变化面积: {边界分析['边界变化面积(亩)']:.3f} 亩")

        # 2. 面积变化分析
        面积分析 = self.计算面积变化(去年掩码, 今年掩码, 像素分辨率)
        print(f"\n📏 面积变化分析:")
        print(f"  新增面积: {面积分析['新增面积(亩)']:.3f} 亩")
        print(f"  减少面积: {面积分析['减少面积(亩)']:.3f} 亩")
        print(f"  净变化: {面积分析['净变化(亩)']:+.3f} 亩")

        # 3. 边界方向变化
        方向分析 = self.检测边界变化类型(去年掩码, 今年掩码, 像素分辨率)
        print(f"\n🧭 边界变化方向:")
        print(f"  {方向分析['主要变化方向']}")
        print(f"  北(上): {方向分析['北边界变化(米)']:.2f}米")
        print(f"  南(下): {方向分析['南边界变化(米)']:.2f}米")
        print(f"  西(左): {方向分析['西边界变化(米)']:.2f}米")
        print(f"  东(右): {方向分析['东边界变化(米)']:.2f}米")

        # 4. 实用建议
        print(f"\n💡 分析建议:")
        if 边界分析['平均边界偏移(米)'] <= 0.5:
            print("  ✅ 精度达标，符合0.5米精度要求")

        if 面积分析['净变化(亩)'] > 0:
            print(f"  📈 耕地增加了 {面积分析['净变化(亩)']:.3f} 亩")
            print("  建议: 可能是开垦了荒地或边界调整")
        elif 面积分析['净变化(亩)'] < 0:
            print(f"  📉 耕地减少了 {abs(面积分析['净变化(亩)']):.3f} 亩")
            print("  建议: 可能是建设占用或退耕还林")
        else:
            print("  📊 耕地面积基本稳定")

        return {
            '边界分析': 边界分析,
            '面积分析': 面积分析,
            '方向分析': 方向分析
        }


# 使用示例
def 使用示例():
    """展示如何使用新的评估方法"""
    print("""
在耕地分析系统.py中替换原来的长宽变化报告部分（约第1190-1220行）:

```python
# 替换原来的长宽变化代码
# 改为使用专业评估工具
try:
    from 耕地变化评价指标 import 耕地变化评估器

    评估器 = 耕地变化评估器()

    # 生成专业报告
    变化报告 = 评估器.生成耕地变化报告(
        去年耕地掩码,
        今年耕地掩码,
        分辨率
    )

    # 保存到文件
    with open("耕地变化专业报告.txt", "w", encoding="utf-8") as f:
        f.write(f"耕地变化专业评估报告\\n")
        f.write(f"生成时间: {__import__('datetime').datetime.now()}\\n\\n")
        f.write(f"精度指标: {变化报告['边界分析']['精度等级']}\\n")
        f.write(f"边界偏移: {变化报告['边界分析']['平均边界偏移(米)']:.3f}米\\n")
        f.write(f"面积变化: {变化报告['面积分析']['净变化(亩)']:+.3f}亩\\n")

except ImportError:
    print("  ⚠️ 专业评估模块不可用，使用基础报告")
    # 保留原有的简单报告
```

这样的报告更有意义，因为：
1. 使用边界偏移而不是长宽变化
2. 提供精度等级评价（是否达到0.5米精度要求）
3. 分析变化方向和原因
4. 更准确地反映耕地边界的变化情况
    """)

if __name__ == "__main__":
    使用示例()