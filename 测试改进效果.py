"""
æµ‹è¯•æ”¹è¿›çš„é¢œè‰²è¯†åˆ«æ•ˆæœ
ä¸ä¾èµ–OpenCV
"""
import numpy as np
import rasterio
from é«˜ç²¾åº¦é¢œè‰²è¯†åˆ« import é«˜ç²¾åº¦é¢œè‰²è¯†åˆ«å™¨

def æµ‹è¯•æ”¹è¿›æ•ˆæœ():
    print("="*60)
    print("æµ‹è¯•æ”¹è¿›çš„é¢œè‰²è¯†åˆ«æ•ˆæœ")
    print("="*60)

    # æµ‹è¯•ä»Šå¹´å›¾åƒ
    tif_path = "jinnian.tif"
    åƒç´ åˆ†è¾¨ç‡ = 0.054500
    é¢„æœŸé¢ç§¯_äº© = 12.6

    if not rasterio.open(tif_path):
        print(f"é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ {tif_path}")
        return

    with rasterio.open(tif_path) as src:
        å›¾åƒæ•°æ® = src.read()
        if å›¾åƒæ•°æ®.shape[0] <= 4:
            å›¾åƒ = np.transpose(å›¾åƒæ•°æ®[:3], (1, 2, 0))
        else:
            å›¾åƒ = å›¾åƒæ•°æ®[1:4]

    # å½’ä¸€åŒ–
    if å›¾åƒ.max() > 1.0:
        å›¾åƒ = å›¾åƒ.astype(np.float32) / 255.0

    print(f"\nğŸ“Š å›¾åƒä¿¡æ¯:")
    print(f"   æ–‡ä»¶: {tif_path}")
    print(f"   å°ºå¯¸: {å›¾åƒ.shape[:2]}")
    print(f"   æ•°æ®èŒƒå›´: {å›¾åƒ.min():.3f} - {å›¾åƒ.max():.3f}")
    print(f"   åƒç´ åˆ†è¾¨ç‡: {åƒç´ åˆ†è¾¨ç‡:.6f} ç±³/åƒç´ ")

    # è®¡ç®—é¢„æœŸåƒç´ æ•°
    é¢„æœŸé¢ç§¯_å¹³æ–¹ç±³ = é¢„æœŸé¢ç§¯_äº© * 666.67
    é¢„æœŸåƒç´ æ•° = é¢„æœŸé¢ç§¯_å¹³æ–¹ç±³ / (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡)
    print(f"\nğŸ“ é¢„æœŸå€¼:")
    print(f"   é¢„æœŸé¢ç§¯: {é¢„æœŸé¢ç§¯_äº©} äº© ({é¢„æœŸé¢ç§¯_å¹³æ–¹ç±³:.0f} å¹³æ–¹ç±³)")
    print(f"   é¢„æœŸåƒç´ æ•°: {é¢„æœŸåƒç´ æ•°:,.0f}")

    # ä½¿ç”¨é«˜ç²¾åº¦é¢œè‰²è¯†åˆ«å™¨
    è¯†åˆ«å™¨ = é«˜ç²¾åº¦é¢œè‰²è¯†åˆ«å™¨()

    # æµ‹è¯•ä¸­å¿ƒåŒºåŸŸ
    h, w = å›¾åƒ.shape[:2]
    æµ‹è¯•å— = å›¾åƒ[h//4:3*h//4, w//4:3*w//4]
    print(f"\nğŸ” æµ‹è¯•åŒºåŸŸ: {æµ‹è¯•å—.shape[:2]} (ä¸­å¿ƒåŒºåŸŸ)")

    # è¯†åˆ«
    æ©ç  = è¯†åˆ«å™¨.å¤šæ–¹æ³•èåˆ(æµ‹è¯•å—)
    è¯†åˆ«åƒç´ æ•° = np.sum(æ©ç  > 0.5)
    è¯†åˆ«é¢ç§¯ = è¯†åˆ«åƒç´ æ•° * (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡) / 666.67

    print(f"\nğŸ“Š è¯†åˆ«ç»“æœ:")
    print(f"   è¯†åˆ«åƒç´ æ•°: {è¯†åˆ«åƒç´ æ•°:,.0f}")
    print(f"   è¯†åˆ«é¢ç§¯: {è¯†åˆ«é¢ç§¯:.2f} äº©")
    print(f"   åå·®: {(è¯†åˆ«é¢ç§¯ - é¢„æœŸé¢ç§¯_äº©)/é¢„æœŸé¢ç§¯_äº©*100:.1f}%")

    # ä¼°ç®—å…¨å›¾é¢ç§¯
    ç¼©æ”¾å› å­ = (å›¾åƒ.shape[0] * å›¾åƒ.shape[1]) / (æµ‹è¯•å—.shape[0] * æµ‹è¯•å—.shape[1])
    å…¨å›¾ä¼°è®¡åƒç´ æ•° = è¯†åˆ«åƒç´ æ•° * ç¼©æ”¾å› å­
    å…¨å›¾ä¼°è®¡é¢ç§¯ = å…¨å›¾ä¼°è®¡åƒç´ æ•° * (åƒç´ åˆ†è¾¨ç‡ * åƒç´ åˆ†è¾¨ç‡) / 666.67

    print(f"\nğŸ“Š å…¨å›¾ä¼°è®¡:")
    print(f"   ä¼°è®¡åƒç´ æ•°: {å…¨å›¾ä¼°è®¡åƒç´ æ•°:,.0f}")
    print(f"   ä¼°è®¡é¢ç§¯: {å…¨å›¾ä¼°è®¡é¢ç§¯:.2f} äº©")

    # åˆ†æé¢œè‰²åˆ†å¸ƒ
    å—_uint8 = (æµ‹è¯•å— * 255).astype(np.uint8)
    R, G, B = å—_uint8[:,:,0].astype(np.float32), å—_uint8[:,:,1].astype(np.float32), å—_uint8[:,:,2].astype(np.float32)
    æ€»åƒç´  = æµ‹è¯•å—.shape[0] * æµ‹è¯•å—.shape[1]

    # è¯†åˆ«çš„åŒºåŸŸ
    è€•åœ°æ©ç  = æ©ç  > 0.5

    print(f"\nğŸ¨ è¯†åˆ«åŒºåŸŸé¢œè‰²åˆ†æ:")
    if np.any(è€•åœ°æ©ç ):
        è€•åœ°R = R[è€•åœ°æ©ç ]
        è€•åœ°G = G[è€•åœ°æ©ç ]
        è€•åœ°B = B[è€•åœ°æ©ç ]

        print(f"   è¯†åˆ«åŒºåŸŸå¹³å‡é¢œè‰²:")
        print(f"     R: {np.mean(è€•åœ°R):.1f}")
        print(f"     G: {np.mean(è€•åœ°G):.1f}")
        print(f"     B: {np.mean(è€•åœ°B):.1f}")
        print(f"   è¯†åˆ«åŒºåŸŸå æ¯”: {np.sum(è€•åœ°æ©ç )/æ€»åƒç´ *100:.1f}%")

    # éè¯†åˆ«åŒºåŸŸ
    éè€•åœ°æ©ç  = ~è€•åœ°æ©ç 
    if np.any(éè€•åœ°æ©ç ):
        éè€•åœ°R = R[éè€•åœ°æ©ç ]
        éè€•åœ°G = G[éè€•åœ°æ©ç ]
        éè€•åœ°B = B[éè€•åœ°æ©ç ]

        print(f"\n   éè¯†åˆ«åŒºåŸŸå¹³å‡é¢œè‰²:")
        print(f"     R: {np.mean(éè€•åœ°R):.1f}")
        print(f"     G: {np.mean(éè€•åœ°G):.1f}")
        print(f"     B: {np.mean(éè€•åœ°B):.1f}")

    print("\n" + "="*60)

if __name__ == "__main__":
    æµ‹è¯•æ”¹è¿›æ•ˆæœ()